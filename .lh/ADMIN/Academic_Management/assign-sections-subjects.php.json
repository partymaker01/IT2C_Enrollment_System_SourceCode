{
    "sourceFile": "ADMIN/Academic_Management/assign-sections-subjects.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1749402254197,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1749402254197,
            "name": "Commit-0",
            "content": "<?php\nsession_start();\ninclude '../../db.php';\n\n// Check admin authentication\nif (!isset($_SESSION['admin_id'])) {\n    header(\"Location: ../../logregfor/admin-login.php\");\n    exit();\n}\n\n$message = '';\n$messageType = '';\n\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\n    $studentId = trim($_POST['studentId'] ?? '');\n    $program = trim($_POST['program'] ?? '');\n    $yearLevel = trim($_POST['yearLevel'] ?? '');\n    $section = trim($_POST['section'] ?? '');\n    $semester = trim($_POST['semester'] ?? '');\n    $schoolYear = trim($_POST['schoolYear'] ?? '');\n    $subjects = $_POST['subjects'] ?? [];\n\n    if ($studentId && $program && $yearLevel && $section && $semester && $schoolYear && count($subjects) > 0) {\n        try {\n            $conn->begin_transaction();\n\n            // Check if student exists\n            $stmt = $conn->prepare(\"SELECT id, first_name, last_name FROM students WHERE student_id = ?\");\n            $stmt->bind_param(\"s\", $studentId);\n            $stmt->execute();\n            $result = $stmt->get_result();\n            $student = $result->fetch_assoc();\n\n            if (!$student) {\n                throw new Exception('Student not found. Please verify the Student ID.');\n            }\n\n            $studentDbId = $student['id'];\n            $studentName = $student['first_name'] . ' ' . $student['last_name'];\n\n            // Check if enrollment already exists for this semester\n            $stmt = $conn->prepare(\"SELECT id FROM enrollments WHERE student_id = ? AND semester = ? AND school_year = ?\");\n            $stmt->bind_param(\"sss\", $studentId, $semester, $schoolYear);\n            $stmt->execute();\n            $result = $stmt->get_result();\n            \n            if ($result->num_rows > 0) {\n                throw new Exception('Student is already enrolled for this semester and school year.');\n            }\n\n            // Create enrollment record\n            $stmt = $conn->prepare(\"INSERT INTO enrollments (student_id, program, year_level, section, semester, school_year, status, enrolled_by, date_enrolled) VALUES (?, ?, ?, ?, ?, ?, 'enrolled', ?, NOW())\");\n            $stmt->bind_param(\"ssssssi\", $studentId, $program, $yearLevel, $section, $semester, $schoolYear, $_SESSION['admin_id']);\n            $stmt->execute();\n            $enrollmentId = $conn->insert_id;\n\n            // Assign subjects\n            $totalUnits = 0;\n            $assignedSubjects = [];\n            \n            foreach ($subjects as $subjectId) {\n                // Get subject details\n                $stmt = $conn->prepare(\"SELECT subject_code, subject_title, units FROM subjects WHERE id = ?\");\n                $stmt->bind_param(\"i\", $subjectId);\n                $stmt->execute();\n                $result = $stmt->get_result();\n                $subject = $result->fetch_assoc();\n                \n                if ($subject) {\n                    // Insert enrollment subject\n                    $stmt = $conn->prepare(\"INSERT INTO enrollment_subjects (enrollment_id, subject_id, subject_code, subject_title, units) VALUES (?, ?, ?, ?, ?)\");\n                    $stmt->bind_param(\"iissi\", $enrollmentId, $subjectId, $subject['subject_code'], $subject['subject_title'], $subject['units']);\n                    $stmt->execute();\n                    \n                    $totalUnits += $subject['units'];\n                    $assignedSubjects[] = $subject['subject_code'] . ' - ' . $subject['subject_title'];\n                }\n            }\n\n            // Update enrollment with total units\n            $stmt = $conn->prepare(\"UPDATE enrollments SET total_units = ? WHERE id = ?\");\n            $stmt->bind_param(\"ii\", $totalUnits, $enrollmentId);\n            $stmt->execute();\n\n            $conn->commit();\n\n            $message = \"Successfully assigned <strong>\" . htmlspecialchars($studentName) . \"</strong> (ID: \" . htmlspecialchars($studentId) . \") to:<br>\n                      Program: <strong>\" . htmlspecialchars($program) . \"</strong><br>\n                      Year Level: <strong>\" . htmlspecialchars($yearLevel) . \"</strong><br>\n                      Section: <strong>\" . htmlspecialchars($section) . \"</strong><br>\n                      Semester: <strong>\" . htmlspecialchars($semester) . \" \" . htmlspecialchars($schoolYear) . \"</strong><br>\n                      Total Units: <strong>\" . $totalUnits . \"</strong><br>\n                      Subjects: <em>\" . implode(', ', $assignedSubjects) . \"</em>\";\n            $messageType = 'success';\n        } catch (Exception $e) {\n            $conn->rollback();\n            $message = 'Error: ' . $e->getMessage();\n            $messageType = 'danger';\n        }\n    } else {\n        $message = 'Please fill in all required fields and select at least one subject.';\n        $messageType = 'danger';\n    }\n}\n\n// Fetch subjects grouped by program and year level\n$subjectsByProgram = [];\n$stmt = $conn->prepare(\"SELECT id, subject_code, subject_title, units, program, year_level FROM subjects ORDER BY program, year_level, subject_code\");\n$stmt->execute();\n$result = $stmt->get_result();\nwhile ($row = $result->fetch_assoc()) {\n    $subjectsByProgram[$row['program']][$row['year_level']][] = $row;\n}\n\n// Get current enrollment period\n$currentPeriod = null;\n$stmt = $conn->prepare(\"SELECT semester, school_year FROM enrollment_periods WHERE status = 'active' ORDER BY id DESC LIMIT 1\");\n$stmt->execute();\n$result = $stmt->get_result();\nif ($result->num_rows > 0) {\n    $currentPeriod = $result->fetch_assoc();\n}\n?>\n\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <title>Assign Sections & Subjects - Admin Panel</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\" />\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css\" rel=\"stylesheet\" />\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n    <link rel=\"icon\" href=\"../../favicon.ico\" type=\"image/x-icon\">\n    <style>\n        body { \n            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%); \n            font-family: 'Segoe UI', sans-serif; \n            min-height: 100vh;\n        }\n        .navbar { \n            background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);\n            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n        }\n        .navbar-brand, .nav-link { \n            color: #fff !important; \n            font-weight: 600; \n            letter-spacing: 0.05em; \n        }\n        .nav-link:hover { \n            color: #c8e6c9 !important; \n            transform: translateY(-1px);\n            transition: all 0.3s ease;\n        }\n        .school-logo { \n            width: 50px; \n            height: 50px; \n            object-fit: cover; \n            border-radius: 50%; \n            margin-right: 10px; \n            border: 2px solid #fff; \n        }\n        .main-card { \n            border-radius: 20px; \n            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); \n            background: rgba(255, 255, 255, 0.95);\n            backdrop-filter: blur(10px);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n        }\n        .period-card {\n            background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);\n            color: white;\n            border-radius: 15px;\n            border: none;\n        }\n        h2 { \n            color: #2e7d32; \n            font-weight: 700; \n            text-align: center;\n            margin-bottom: 2rem;\n        }\n        .divider { \n            height: 2px; \n            background: linear-gradient(90deg, #c5e1a5 0%, #2e7d32 50%, #c5e1a5 100%); \n            margin: 2rem 0; \n            border-radius: 1px;\n        }\n        .form-floating label { \n            font-size: 0.9rem; \n            color: #666;\n        }\n        .form-control:focus, .form-select:focus {\n            border-color: #2e7d32;\n            box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.25);\n        }\n        .subjects-container {\n            max-height: 300px;\n            overflow-y: auto;\n            border: 2px solid #e9ecef;\n            border-radius: 10px;\n            padding: 15px;\n            background: #f8f9fa;\n        }\n        .subject-item {\n            background: white;\n            border: 1px solid #dee2e6;\n            border-radius: 8px;\n            padding: 10px;\n            margin-bottom: 8px;\n            transition: all 0.3s ease;\n        }\n        .subject-item:hover {\n            border-color: #2e7d32;\n            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.1);\n        }\n        .subject-item input[type=\"checkbox\"]:checked + label {\n            color: #2e7d32;\n            font-weight: 600;\n        }\n        .btn-success {\n            background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);\n            border: none;\n            padding: 12px 30px;\n            font-weight: 600;\n            border-radius: 10px;\n            transition: all 0.3s ease;\n        }\n        .btn-success:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 5px 15px rgba(46, 125, 50, 0.4);\n        }\n        .alert {\n            border-radius: 10px;\n            border: none;\n        }\n        .units-counter {\n            background: #e3f2fd;\n            border: 2px solid #2196f3;\n            border-radius: 10px;\n            padding: 15px;\n            text-align: center;\n            font-weight: 600;\n            color: #1976d2;\n        }\n        @media (max-width: 575.98px) { \n            .main-card { \n                margin: 10px;\n                padding: 1rem; \n            } \n        }\n    </style>\n</head>\n<body>\n  <nav class=\"navbar navbar-expand-lg navbar-dark py-3\">\n    <div class=\"container-fluid\">\n      <a class=\"navbar-brand d-flex align-items-center\" href=\"#\">\n        <img src=\"../../picture/tlgc_pic.jpg\" alt=\"School Logo\" class=\"school-logo\">\n        Admin Panel\n      </a>\n      <button class=\"navbar-toggler\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#navbarNav\">\n        <span class=\"navbar-toggler-icon\"></span>\n      </button>\n      <div class=\"collapse navbar-collapse\" id=\"navbarNav\">\n        <ul class=\"navbar-nav ms-auto\">\n          <li class=\"nav-item\">\n            <a class=\"nav-link\" href=\"../admin-dashboard.php\">\n              <i class=\"bi bi-arrow-left\"></i> Back to Dashboard\n            </a>\n          </li>\n        </ul>\n      </div>\n    </div>\n  </nav>\n\n<div class=\"container py-5\">\n    <!-- Current Period Display -->\n    <?php if ($currentPeriod): ?>\n    <div class=\"row mb-4\">\n      <div class=\"col-12\">\n        <div class=\"card period-card\">\n          <div class=\"card-body text-center\">\n            <h5 class=\"card-title mb-2\">\n              <i class=\"bi bi-calendar-event me-2\"></i>Current Enrollment Period\n            </h5>\n            <p class=\"mb-0\">\n              <?= htmlspecialchars($currentPeriod['semester']) ?> - <?= htmlspecialchars($currentPeriod['school_year']) ?>\n            </p>\n          </div>\n        </div>\n      </div>\n    </div>\n    <?php endif; ?>\n\n    <h2><i class=\"bi bi-person-plus-fill me-2\"></i>Assign Sections & Subjects</h2>\n\n    <div class=\"card main-card mx-auto\" style=\"max-width: 1000px;\">\n        <div class=\"card-body p-4\">\n            <?php if ($message): ?>\n                <div class=\"alert alert-<?= $messageType ?> mb-4\">\n                    <i class=\"bi bi-<?= $messageType === 'success' ? 'check-circle' : 'exclamation-triangle' ?> me-2\"></i>\n                    <?= $message ?>\n                </div>\n            <?php endif; ?>\n\n            <form method=\"POST\" action=\"\" id=\"assignmentForm\">\n                <!-- Student Information -->\n                <div class=\"row g-3 mb-4\">\n                    <div class=\"col-md-6\">\n                        <div class=\"form-floating\">\n                            <input type=\"text\" class=\"form-control\" id=\"studentId\" name=\"studentId\" \n                                   placeholder=\"Student ID\" value=\"<?= htmlspecialchars($_POST['studentId'] ?? '') ?>\" required>\n                            <label for=\"studentId\"><i class=\"bi bi-person-badge me-1\"></i>Student ID</label>\n                        </div>\n                    </div>\n                    <div class=\"col-md-6\">\n                        <button type=\"button\" class=\"btn btn-outline-primary w-100 h-100\" id=\"verifyStudent\">\n                            <i class=\"bi bi-search me-1\"></i>Verify Student\n                        </button>\n                    </div>\n                </div>\n\n                <div id=\"studentInfo\" style=\"display: none;\" class=\"alert alert-info mb-4\">\n                    <strong>Student Found:</strong> <span id=\"studentName\"></span>\n                </div>\n\n                <div class=\"divider\"></div>\n\n                <!-- Academic Information -->\n                <div class=\"row g-3 mb-4\">\n                    <div class=\"col-md-3\">\n                        <div class=\"form-floating\">\n                            <select class=\"form-select\" id=\"program\" name=\"program\" required>\n                                <option value=\"\" disabled <?= empty($_POST['program']) ? 'selected' : '' ?>>Select</option>\n                                <?php \n                                $programs = ['IT', 'HRMT', 'ECT', 'HST', 'ET', 'TVET'];\n                                foreach ($programs as $prog): ?>\n                                    <option value=\"<?= $prog ?>\" <?= ($_POST['program'] ?? '') === $prog ? 'selected' : '' ?>><?= $prog ?></option>\n                                <?php endforeach; ?>\n                            </select>\n                            <label for=\"program\"><i class=\"bi bi-mortarboard me-1\"></i>Program</label>\n                        </div>\n                    </div>\n                    <div class=\"col-md-3\">\n                        <div class=\"form-floating\">\n                            <select class=\"form-select\" id=\"yearLevel\" name=\"yearLevel\" required>\n                                <option value=\"\" disabled <?= empty($_POST['yearLevel']) ? 'selected' : '' ?>>Select</option>\n                                <?php \n                                $years = ['1st Year', '2nd Year', '3rd Year'];\n                                foreach ($years as $yr): ?>\n                                    <option value=\"<?= $yr ?>\" <?= ($_POST['yearLevel'] ?? '') === $yr ? 'selected' : '' ?>><?= $yr ?></option>\n                                <?php endforeach; ?>\n                            </select>\n                            <label for=\"yearLevel\"><i class=\"bi bi-bar-chart-steps me-1\"></i>Year Level</label>\n                        </div>\n                    </div>\n                    <div class=\"col-md-2\">\n                        <div class=\"form-floating\">\n                            <select class=\"form-select\" id=\"section\" name=\"section\" required>\n                                <option value=\"\" disabled <?= empty($_POST['section']) ? 'selected' : '' ?>>Select</option>\n                                <?php foreach (range('A', 'H') as $sec): ?>\n                                    <option value=\"<?= $sec ?>\" <?= ($_POST['section'] ?? '') === $sec ? 'selected' : '' ?>><?= $sec ?></option>\n                                <?php endforeach; ?>\n                            </select>\n                            <label for=\"section\"><i class=\"bi bi-collection me-1\"></i>Section</label>\n                        </div>\n                    </div>\n                    <div class=\"col-md-2\">\n                        <div class=\"form-floating\">\n                            <select class=\"form-select\" id=\"semester\" name=\"semester\" required>\n                                <option value=\"\" disabled>Select</option>\n                                <option value=\"1st Semester\" <?= ($currentPeriod['semester'] ?? '') === '1st Semester' ? 'selected' : '' ?>>1st Semester</option>\n                                <option value=\"2nd Semester\" <?= ($currentPeriod['semester'] ?? '') === '2nd Semester' ? 'selected' : '' ?>>2nd Semester</option>\n                                <option value=\"Summer\" <?= ($currentPeriod['semester'] ?? '') === 'Summer' ? 'selected' : '' ?>>Summer</option>\n                            </select>\n                            <label for=\"semester\"><i class=\"bi bi-calendar3 me-1\"></i>Semester</label>\n                        </div>\n                    </div>\n                    <div class=\"col-md-2\">\n                        <div class=\"form-floating\">\n                            <input type=\"text\" class=\"form-control\" id=\"schoolYear\" name=\"schoolYear\" \n                                   placeholder=\"2024-2025\" value=\"<?= htmlspecialchars($currentPeriod['school_year'] ?? '') ?>\" required>\n                            <label for=\"schoolYear\"><i class=\"bi bi-calendar-range me-1\"></i>School Year</label>\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"divider\"></div>\n\n                <!-- Subject Assignment -->\n                <div class=\"row\">\n                    <div class=\"col-md-8\">\n                        <label class=\"form-label fw-bold mb-3\">\n                            <i class=\"bi bi-book me-1\"></i>Available Subjects\n                        </label>\n                        <div class=\"subjects-container\" id=\"subjectsContainer\">\n                            <p class=\"text-muted text-center\">Please select a program and year level to view available subjects.</p>\n                        </div>\n                    </div>\n                    <div class=\"col-md-4\">\n                        <label class=\"form-label fw-bold mb-3\">\n                            <i class=\"bi bi-calculator me-1\"></i>Units Summary\n                        </label>\n                        <div class=\"units-counter\">\n                            <div class=\"h4 mb-1\" id=\"totalUnits\">0</div>\n                            <div class=\"small\">Total Units</div>\n                        </div>\n                        <div class=\"mt-3\">\n                            <div class=\"small text-muted\">\n                                <strong>Selected Subjects:</strong>\n                                <div id=\"selectedSubjects\" class=\"mt-2\">None selected</div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"divider\"></div>\n\n                <div class=\"d-flex justify-content-end gap-3\">\n                    <button type=\"reset\" class=\"btn btn-outline-secondary\">\n                        <i class=\"bi bi-arrow-clockwise me-1\"></i>Clear Form\n                    </button>\n                    <button type=\"submit\" class=\"btn btn-success\" id=\"submitBtn\" disabled>\n                        <i class=\"bi bi-check-circle me-1\"></i>Assign Student\n                    </button>\n                </div>\n            </form>\n        </div>\n    </div>\n</div>\n\n<script>\n// Subject data from PHP\nconst subjectsByProgram = <?= json_encode($subjectsByProgram) ?>;\n\n// Verify student\ndocument.getElementById('verifyStudent').addEventListener('click', function() {\n    const studentId = document.getElementById('studentId').value;\n    if (!studentId) {\n        alert('Please enter a Student ID');\n        return;\n    }\n\n    // Simulate student verification (you can implement actual AJAX call)\n    fetch('verify-student.php', {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded',\n        },\n        body: 'student_id=' + encodeURIComponent(studentId)\n    })\n    .then(response => response.json())\n    .then(data => {\n        if (data.success) {\n            document.getElementById('studentInfo').style.display = 'block';\n            document.getElementById('studentName').textContent = data.name;\n        } else {\n            alert('Student not found');\n            document.getElementById('studentInfo').style.display = 'none';\n        }\n    })\n    .catch(error => {\n        console.error('Error:', error);\n        alert('Error verifying student');\n    });\n});\n\n// Update subjects when program/year level changes\nfunction updateSubjects() {\n    const program = document.getElementById('program').value;\n    const yearLevel = document.getElementById('yearLevel').value;\n    const container = document.getElementById('subjectsContainer');\n\n    if (!program || !yearLevel) {\n        container.innerHTML = '<p class=\"text-muted text-center\">Please select a program and year level to view available subjects.</p>';\n        return;\n    }\n\n    const subjects = subjectsByProgram[program]?.[yearLevel] || [];\n    \n    if (subjects.length === 0) {\n        container.innerHTML = '<p class=\"text-muted text-center\">No subjects available for this program and year level.</p>';\n        return;\n    }\n\n    let html = '';\n    subjects.forEach(subject => {\n        html += `\n            <div class=\"subject-item\">\n                <div class=\"form-check\">\n                    <input class=\"form-check-input subject-checkbox\" type=\"checkbox\" \n                           value=\"${subject.id}\" id=\"subject_${subject.id}\" \n                           data-units=\"${subject.units}\" data-title=\"${subject.subject_code} - ${subject.subject_title}\">\n                    <label class=\"form-check-label w-100\" for=\"subject_${subject.id}\">\n                        <div class=\"d-flex justify-content-between\">\n                            <span><strong>${subject.subject_code}</strong> - ${subject.subject_title}</span>\n                            <span class=\"badge bg-primary\">${subject.units} units</span>\n                        </div>\n                    </label>\n                </div>\n            </div>\n        `;\n    });\n\n    container.innerHTML = html;\n\n    // Add event listeners to checkboxes\n    document.querySelectorAll('.subject-checkbox').forEach(checkbox => {\n        checkbox.addEventListener('change', updateUnitsCounter);\n    });\n}\n\n// Update units counter\nfunction updateUnitsCounter() {\n    const checkboxes = document.querySelectorAll('.subject-checkbox:checked');\n    let totalUnits = 0;\n    let selectedSubjects = [];\n\n    checkboxes.forEach(checkbox => {\n        totalUnits += parseInt(checkbox.dataset.units);\n        selectedSubjects.push(checkbox.dataset.title);\n    });\n\n    document.getElementById('totalUnits').textContent = totalUnits;\n    \n    const selectedSubjectsDiv = document.getElementById('selectedSubjects');\n    if (selectedSubjects.length > 0) {\n        selectedSubjectsDiv.innerHTML = selectedSubjects.map(subject => \n            `<div class=\"small text-success mb-1\"><i class=\"bi bi-check me-1\"></i>${subject}</div>`\n        ).join('');\n    } else {\n        selectedSubjectsDiv.innerHTML = '<div class=\"text-muted\">None selected</div>';\n    }\n\n    // Enable/disable submit button\n    const submitBtn = document.getElementById('submitBtn');\n    submitBtn.disabled = selectedSubjects.length === 0;\n}\n\n// Event listeners\ndocument.getElementById('program').addEventListener('change', updateSubjects);\ndocument.getElementById('yearLevel').addEventListener('change', updateSubjects);\n\n// Form validation\ndocument.getElementById('assignmentForm').addEventListener('submit', function(e) {\n    const selectedSubjects = document.querySelectorAll('.subject-checkbox:checked');\n    if (selectedSubjects.length === 0) {\n        e.preventDefault();\n        alert('Please select at least one subject.');\n        return;\n    }\n\n    if (!confirm('Are you sure you want to assign this student to the selected subjects?')) {\n        e.preventDefault();\n    }\n});\n\n// Initialize\nupdateSubjects();\n</script>\n</body>\n</html>\n"
        }
    ]
}