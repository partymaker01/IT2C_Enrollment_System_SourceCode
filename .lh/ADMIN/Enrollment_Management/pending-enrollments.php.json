{
    "sourceFile": "ADMIN/Enrollment_Management/pending-enrollments.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 23,
            "patches": [
                {
                    "date": 1749397660351,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1749404418345,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -119,8 +119,9 @@\n     <title>Pending Enrollments - TLGC Admin</title>\n     <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n     <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css\" rel=\"stylesheet\">\n     <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n+    <link rel=\"icon\" href=\"../picture/tlgc_pic.jpg\" type=\"image/x-icon\">\n     <style>\n         body {\n             background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);\n             font-family: 'Segoe UI', sans-serif;\n"
                },
                {
                    "date": 1749406530954,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -338,84 +338,63 @@\n         </div>\n     </div>\n \n     <script>\n-        let currentEnrollmentId = null;\n-        let currentAction = null;\n+// Improved JavaScript with better error handling\n+const currentAction = \"\" // Declare currentAction variable\n+const currentEnrollmentId = \"\" // Declare currentEnrollmentId variable\n \n-        function processEnrollment(enrollmentId, action, studentName) {\n-            currentEnrollmentId = enrollmentId;\n-            currentAction = action;\n-            \n-            const modal = new bootstrap.Modal(document.getElementById('actionModal'));\n-            const modalTitle = document.getElementById('modalTitle');\n-            const modalMessage = document.getElementById('modalMessage');\n-            const confirmBtn = document.getElementById('confirmBtn');\n-            \n-            // Set modal content based on action\n-            switch(action) {\n-                case 'approve':\n-                    modalTitle.textContent = 'Approve Enrollment';\n-                    modalMessage.textContent = `Are you sure you want to approve the enrollment for ${studentName}? This will also update their Student ID if needed.`;\n-                    confirmBtn.className = 'btn btn-success';\n-                    confirmBtn.textContent = 'Approve';\n-                    break;\n-                case 'reject':\n-                    modalTitle.textContent = 'Reject Enrollment';\n-                    modalMessage.textContent = `Are you sure you want to reject the enrollment for ${studentName}?`;\n-                    confirmBtn.className = 'btn btn-danger';\n-                    confirmBtn.textContent = 'Reject';\n-                    break;\n-                case 'missing_documents':\n-                    modalTitle.textContent = 'Mark as Missing Documents';\n-                    modalMessage.textContent = `Mark ${studentName}'s enrollment as missing documents?`;\n-                    confirmBtn.className = 'btn btn-warning';\n-                    confirmBtn.textContent = 'Mark as Missing';\n-                    break;\n-            }\n-            \n-            modal.show();\n-        }\n+document.getElementById(\"confirmBtn\").addEventListener(\"click\", function () {\n+  const remarks = document.getElementById(\"remarksInput\").value\n \n-        document.getElementById('confirmBtn').addEventListener('click', function() {\n-            const remarks = document.getElementById('remarksInput').value;\n-            \n-            // Show loading state\n-            this.disabled = true;\n-            this.textContent = 'Processing...';\n-            \n-            // Send AJAX request - UPDATED: changed filename\n-            fetch('process-enrollment-updated.php', {\n-                method: 'POST',\n-                headers: {\n-                    'Content-Type': 'application/x-www-form-urlencoded',\n-                },\n-                body: new URLSearchParams({\n-                    action: currentAction,\n-                    enrollment_id: currentEnrollmentId,\n-                    remarks: remarks\n-                })\n-            })\n-            .then(response => response.json())\n-            .then(data => {\n-                if (data.success) {\n-                    // Show success message\n-                    alert(data.message);\n-                    // Reload page to update the table\n-                    location.reload();\n-                } else {\n-                    alert('Error: ' + data.message);\n-                    // Reset button\n-                    this.disabled = false;\n-                    this.textContent = 'Confirm';\n-                }\n-            })\n-            .catch(error => {\n-                alert('Error: ' + error.message);\n-                // Reset button\n-                this.disabled = false;\n-                this.textContent = 'Confirm';\n-            });\n-        });\n+  // Show loading state\n+  this.disabled = true\n+  this.textContent = \"Processing...\"\n+\n+  // FIXED: Make sure the filename matches your actual PHP file\n+  fetch(\"process-enrollment.php\", {\n+    // Changed from 'process-enrollment-updated.php'\n+    method: \"POST\",\n+    headers: {\n+      \"Content-Type\": \"application/x-www-form-urlencoded\",\n+    },\n+    body: new URLSearchParams({\n+      action: currentAction,\n+      enrollment_id: currentEnrollmentId,\n+      remarks: remarks,\n+    }),\n+  })\n+    .then((response) => {\n+      // Add debugging to see what we actually received\n+      console.log(\"Response status:\", response.status)\n+      console.log(\"Response headers:\", response.headers.get(\"content-type\"))\n+\n+      // Check if response is actually JSON\n+      const contentType = response.headers.get(\"content-type\")\n+      if (!contentType || !contentType.includes(\"application/json\")) {\n+        throw new Error(\"Server returned non-JSON response\")\n+      }\n+\n+      return response.json()\n+    })\n+    .then((data) => {\n+      console.log(\"Parsed JSON:\", data) // Debug output\n+\n+      if (data.success) {\n+        alert(data.message)\n+        location.reload()\n+      } else {\n+        alert(\"Error: \" + data.message)\n+        this.disabled = false\n+        this.textContent = \"Confirm\"\n+      }\n+    })\n+    .catch((error) => {\n+      console.error(\"Fetch error:\", error)\n+      alert(\"Error: \" + error.message)\n+      this.disabled = false\n+      this.textContent = \"Confirm\"\n+    })\n+})\n     </script>\n </body>\n </html>\n"
                },
                {
                    "date": 1749406547962,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -338,63 +338,84 @@\n         </div>\n     </div>\n \n     <script>\n-// Improved JavaScript with better error handling\n-const currentAction = \"\" // Declare currentAction variable\n-const currentEnrollmentId = \"\" // Declare currentEnrollmentId variable\n+        let currentEnrollmentId = null;\n+        let currentAction = null;\n \n-document.getElementById(\"confirmBtn\").addEventListener(\"click\", function () {\n-  const remarks = document.getElementById(\"remarksInput\").value\n+        function processEnrollment(enrollmentId, action, studentName) {\n+            currentEnrollmentId = enrollmentId;\n+            currentAction = action;\n+            \n+            const modal = new bootstrap.Modal(document.getElementById('actionModal'));\n+            const modalTitle = document.getElementById('modalTitle');\n+            const modalMessage = document.getElementById('modalMessage');\n+            const confirmBtn = document.getElementById('confirmBtn');\n+            \n+            // Set modal content based on action\n+            switch(action) {\n+                case 'approve':\n+                    modalTitle.textContent = 'Approve Enrollment';\n+                    modalMessage.textContent = `Are you sure you want to approve the enrollment for ${studentName}? This will also update their Student ID if needed.`;\n+                    confirmBtn.className = 'btn btn-success';\n+                    confirmBtn.textContent = 'Approve';\n+                    break;\n+                case 'reject':\n+                    modalTitle.textContent = 'Reject Enrollment';\n+                    modalMessage.textContent = `Are you sure you want to reject the enrollment for ${studentName}?`;\n+                    confirmBtn.className = 'btn btn-danger';\n+                    confirmBtn.textContent = 'Reject';\n+                    break;\n+                case 'missing_documents':\n+                    modalTitle.textContent = 'Mark as Missing Documents';\n+                    modalMessage.textContent = `Mark ${studentName}'s enrollment as missing documents?`;\n+                    confirmBtn.className = 'btn btn-warning';\n+                    confirmBtn.textContent = 'Mark as Missing';\n+                    break;\n+            }\n+            \n+            modal.show();\n+        }\n \n-  // Show loading state\n-  this.disabled = true\n-  this.textContent = \"Processing...\"\n-\n-  // FIXED: Make sure the filename matches your actual PHP file\n-  fetch(\"process-enrollment.php\", {\n-    // Changed from 'process-enrollment-updated.php'\n-    method: \"POST\",\n-    headers: {\n-      \"Content-Type\": \"application/x-www-form-urlencoded\",\n-    },\n-    body: new URLSearchParams({\n-      action: currentAction,\n-      enrollment_id: currentEnrollmentId,\n-      remarks: remarks,\n-    }),\n-  })\n-    .then((response) => {\n-      // Add debugging to see what we actually received\n-      console.log(\"Response status:\", response.status)\n-      console.log(\"Response headers:\", response.headers.get(\"content-type\"))\n-\n-      // Check if response is actually JSON\n-      const contentType = response.headers.get(\"content-type\")\n-      if (!contentType || !contentType.includes(\"application/json\")) {\n-        throw new Error(\"Server returned non-JSON response\")\n-      }\n-\n-      return response.json()\n-    })\n-    .then((data) => {\n-      console.log(\"Parsed JSON:\", data) // Debug output\n-\n-      if (data.success) {\n-        alert(data.message)\n-        location.reload()\n-      } else {\n-        alert(\"Error: \" + data.message)\n-        this.disabled = false\n-        this.textContent = \"Confirm\"\n-      }\n-    })\n-    .catch((error) => {\n-      console.error(\"Fetch error:\", error)\n-      alert(\"Error: \" + error.message)\n-      this.disabled = false\n-      this.textContent = \"Confirm\"\n-    })\n-})\n+        document.getElementById('confirmBtn').addEventListener('click', function() {\n+            const remarks = document.getElementById('remarksInput').value;\n+            \n+            // Show loading state\n+            this.disabled = true;\n+            this.textContent = 'Processing...';\n+            \n+            // Send AJAX request - UPDATED: changed filename\n+            fetch('process-enrollment-updated.php', {\n+                method: 'POST',\n+                headers: {\n+                    'Content-Type': 'application/x-www-form-urlencoded',\n+                },\n+                body: new URLSearchParams({\n+                    action: currentAction,\n+                    enrollment_id: currentEnrollmentId,\n+                    remarks: remarks\n+                })\n+            })\n+            .then(response => response.json())\n+            .then(data => {\n+                if (data.success) {\n+                    // Show success message\n+                    alert(data.message);\n+                    // Reload page to update the table\n+                    location.reload();\n+                } else {\n+                    alert('Error: ' + data.message);\n+                    // Reset button\n+                    this.disabled = false;\n+                    this.textContent = 'Confirm';\n+                }\n+            })\n+            .catch(error => {\n+                alert('Error: ' + error.message);\n+                // Reset button\n+                this.disabled = false;\n+                this.textContent = 'Confirm';\n+            });\n+        });\n     </script>\n </body>\n </html>\n"
                },
                {
                    "date": 1749406721382,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,32 +1,34 @@\n-<?php\n-session_start();\n-include '../../db.php';\n-include 'generate-student-id.php'; // Include ang helper file\n+<?php\\\n+session_start()\n+\\\n+include '../../db.php'\n+\\\n+include 'generate-student-id.php' // Include ang helper file\n \n // Check admin authentication\n-if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n-    header(\"Location: ../../logregfor/admin-login.php\");\n-    exit();\n+if (!isset($_SESSION[\"admin_logged_in\"]) || $_SESSION[\"admin_logged_in\"] !== true) {\n+  header(\"Location: ../../logregfor/admin-login.php\")\n+  exit()\n }\n \n // Handle AJAX requests for enrollment actions\n-if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {\n-    $enrollmentId = $_POST['enrollment_id'] ?? 0;\n-    $action = $_POST['action'];\n-    $remarks = $_POST['remarks'] ?? '';\n-    \n-    $response = ['success' => false, 'message' => ''];\n-    \n-    try {\n+if ($_SERVER[\"REQUEST_METHOD\"] === \"POST\" && isset($_POST[\"action\"])) {\n+  $enrollmentId = $_POST[\"enrollment_id\"] ?? 0\n+  $action = $_POST[\"action\"]\n+  $remarks = $_POST[\"remarks\"] ?? \"\"\n+\n+  $response = [\"success' => false, 'message' => '\"]\n+\n+  try {\n         switch ($action) {\n             case 'approve':\n-                // UPDATED: Get enrollment details first\n-                $stmt = $conn->prepare(\"\n-                    SELECT e.*, s.student_id as current_student_id \n-                    FROM enrollments e \n-                    JOIN students s ON e.student_id = s.student_id \n-                    WHERE e.id = ?\n+                // UPDATED: Get enrollment details first\\\n+                $stmt = $conn->prepare(\"\\\n+                    SELECT e.*, s.student_id as current_student_id \\\n+                    FROM enrollments e \\\n+                    JOIN students s ON e.student_id = s.student_id \\\n+                    WHERE e.id = ?\\\n                 \");\n                 $stmt->bind_param(\"i\", $enrollmentId);\n                 $stmt->execute();\n                 $enrollment = $stmt->get_result()->fetch_assoc();\n@@ -53,10 +55,10 @@\n                     // Update enrollment status\n                     $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'approved', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n                     $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                     $stmt->execute();\n-                    \n-                    $response = ['success' => true, 'message' => $message];\n+                    \\\n+                    $response = ['success\\' => true, \\'message\\' => $message];\n                 } else {\n                     throw new Exception(\"Enrollment not found\");\n                 }\n                 break;\n@@ -64,25 +66,27 @@\n             case 'reject':\n                 $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'rejected', processed_by = ?, date_processed = NOW(), rejection_reason = ? WHERE id = ?\");\n                 $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                 $stmt->execute();\n-                $response = ['success' => true, 'message' => 'Enrollment rejected successfully!'];\n+                $response = ['success\\' => true, \\'message\\' => \\'Enrollment rejected successfully!'];\n                 break;\n                 \n             case 'missing_documents':\n                 $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'missing_documents', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n                 $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                 $stmt->execute();\n-                $response = ['success' => true, 'message' => 'Marked as missing documents!'];\n+                $response = ['success\\' => true, \\'message\\' => \\'Marked as missing documents!'];\n                 break;\n-        }\n-    } catch (Exception $e) {\n-        $response = ['success' => false, 'message' => 'Error: ' . $e->getMessage()];\n-    }\n-    \n-    header('Content-Type: application/json');\n-    echo json_encode($response);\n-    exit();\n+        }\\\n+    } catch (Exception\n+  $e\n+  )\n+  $response = ['success\\' => false, \\'message\\' => \\'Error: ' . $e->getMessage()];\n+\n+  header(\"Content-Type: application/json\")\n+  echo\n+  json_encode($response)\n+  exit()\n }\n \n // Get pending enrollments with student details\n $stmt = $conn->prepare(\"\n@@ -100,15 +104,16 @@\n $stmt->execute();\n $pendingEnrollments = $stmt->get_result()->fetch_all(MYSQLI_ASSOC);\n \n // Get statistics\n-$stats = [];\n-$statuses = ['pending', 'approved', 'rejected', 'missing_documents'];\n-foreach ($statuses as $status) {\n-    $stmt = $conn->prepare(\"SELECT COUNT(*) as count FROM enrollments WHERE status = ?\");\n-    $stmt->bind_param(\"s\", $status);\n-    $stmt->execute();\n-    $stats[$status] = $stmt->get_result()->fetch_assoc()['count'];\n+$stats = []\n+$statuses = [\"pending\", \"approved\", \"rejected\", \"missing_documents\"]\n+foreach($statuses as $status)\n+{\n+  $stmt = $conn->prepare(\"SELECT COUNT(*) as count FROM enrollments WHERE status = ?\");\n+  $stmt->bind_param(\"s\", $status);\n+  $stmt->execute();\n+  $stats[$status] = $stmt->get_result()->fetch_assoc()['count'];\n }\n ?>\n \n <!DOCTYPE html>\n@@ -119,9 +124,10 @@\n     <title>Pending Enrollments - TLGC Admin</title>\n     <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n     <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css\" rel=\"stylesheet\">\n     <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n-    <link rel=\"icon\" href=\"../picture/tlgc_pic.jpg\" type=\"image/x-icon\">\n+    <link rel=\"icon\" href=\"../picture/tlgc_pic.jpg\"\n+type=\"image/x-icon\">\n     <style>\n         body {\n             background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);\n             font-family: 'Segoe UI', sans-serif;\n@@ -162,9 +168,10 @@\n     </style>\n </head>\n <body>\n     <!-- Navigation -->\n-    <nav class=\"navbar navbar-expand-lg navbar-dark py-3\">\n+    <nav\n+class=\"navbar navbar-expand-lg navbar-dark py-3\">\n         <div class=\"container-fluid\">\n             <a class=\"navbar-brand d-flex align-items-center\" href=\"../admin-dashboard.php\">\n                 <img src=\"../../picture/tlgc_pic.jpg\" alt=\"School Logo\" class=\"school-logo\">\n                 TLGC Admin Panel\n@@ -383,9 +390,9 @@\n             this.disabled = true;\n             this.textContent = 'Processing...';\n             \n             // Send AJAX request - UPDATED: changed filename\n-            fetch('process-enrollment-updated.php', {\n+            fetch('process-enrollment.php', {\n                 method: 'POST',\n                 headers: {\n                     'Content-Type': 'application/x-www-form-urlencoded',\n                 },\n@@ -394,9 +401,22 @@\n                     enrollment_id: currentEnrollmentId,\n                     remarks: remarks\n                 })\n             })\n-            .then(response => response.json())\n+            .then(response => {\n+                // Add debugging to see what we actually received\n+                if (!response.ok) {\n+                    throw new Error('Server returned status: ' + response.status);\n+                }\n+                \n+                // Check if response is actually JSON\n+                const contentType = response.headers.get('content-type');\n+                if (!contentType || !contentType.includes('application/json')) {\n+                    throw new Error('Server returned non-JSON response');\n+                }\n+                \n+                return response.json();\n+            })\n             .then(data => {\n                 if (data.success) {\n                     // Show success message\n                     alert(data.message);\n"
                },
                {
                    "date": 1749406770176,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,34 +1,32 @@\n-<?php\\\n-session_start()\n-\\\n-include '../../db.php'\n-\\\n-include 'generate-student-id.php' // Include ang helper file\n+<?php\n+session_start();\n+include '../../db.php';\n+include 'generate-student-id.php'; // Include ang helper file\n \n // Check admin authentication\n-if (!isset($_SESSION[\"admin_logged_in\"]) || $_SESSION[\"admin_logged_in\"] !== true) {\n-  header(\"Location: ../../logregfor/admin-login.php\")\n-  exit()\n+if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n+    header(\"Location: ../../logregfor/admin-login.php\");\n+    exit();\n }\n \n // Handle AJAX requests for enrollment actions\n-if ($_SERVER[\"REQUEST_METHOD\"] === \"POST\" && isset($_POST[\"action\"])) {\n-  $enrollmentId = $_POST[\"enrollment_id\"] ?? 0\n-  $action = $_POST[\"action\"]\n-  $remarks = $_POST[\"remarks\"] ?? \"\"\n-\n-  $response = [\"success' => false, 'message' => '\"]\n-\n-  try {\n+if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {\n+    $enrollmentId = $_POST['enrollment_id'] ?? 0;\n+    $action = $_POST['action'];\n+    $remarks = $_POST['remarks'] ?? '';\n+    \n+    $response = ['success' => false, 'message' => ''];\n+    \n+    try {\n         switch ($action) {\n             case 'approve':\n-                // UPDATED: Get enrollment details first\\\n-                $stmt = $conn->prepare(\"\\\n-                    SELECT e.*, s.student_id as current_student_id \\\n-                    FROM enrollments e \\\n-                    JOIN students s ON e.student_id = s.student_id \\\n-                    WHERE e.id = ?\\\n+                // UPDATED: Get enrollment details first\n+                $stmt = $conn->prepare(\"\n+                    SELECT e.*, s.student_id as current_student_id \n+                    FROM enrollments e \n+                    JOIN students s ON e.student_id = s.student_id \n+                    WHERE e.id = ?\n                 \");\n                 $stmt->bind_param(\"i\", $enrollmentId);\n                 $stmt->execute();\n                 $enrollment = $stmt->get_result()->fetch_assoc();\n@@ -55,10 +53,10 @@\n                     // Update enrollment status\n                     $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'approved', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n                     $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                     $stmt->execute();\n-                    \\\n-                    $response = ['success\\' => true, \\'message\\' => $message];\n+                    \n+                    $response = ['success' => true, 'message' => $message];\n                 } else {\n                     throw new Exception(\"Enrollment not found\");\n                 }\n                 break;\n@@ -66,27 +64,25 @@\n             case 'reject':\n                 $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'rejected', processed_by = ?, date_processed = NOW(), rejection_reason = ? WHERE id = ?\");\n                 $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                 $stmt->execute();\n-                $response = ['success\\' => true, \\'message\\' => \\'Enrollment rejected successfully!'];\n+                $response = ['success' => true, 'message' => 'Enrollment rejected successfully!'];\n                 break;\n                 \n             case 'missing_documents':\n                 $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'missing_documents', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n                 $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                 $stmt->execute();\n-                $response = ['success\\' => true, \\'message\\' => \\'Marked as missing documents!'];\n+                $response = ['success' => true, 'message' => 'Marked as missing documents!'];\n                 break;\n-        }\\\n-    } catch (Exception\n-  $e\n-  )\n-  $response = ['success\\' => false, \\'message\\' => \\'Error: ' . $e->getMessage()];\n-\n-  header(\"Content-Type: application/json\")\n-  echo\n-  json_encode($response)\n-  exit()\n+        }\n+    } catch (Exception $e) {\n+        $response = ['success' => false, 'message' => 'Error: ' . $e->getMessage()];\n+    }\n+    \n+    header('Content-Type: application/json');\n+    echo json_encode($response);\n+    exit();\n }\n \n // Get pending enrollments with student details\n $stmt = $conn->prepare(\"\n@@ -104,16 +100,15 @@\n $stmt->execute();\n $pendingEnrollments = $stmt->get_result()->fetch_all(MYSQLI_ASSOC);\n \n // Get statistics\n-$stats = []\n-$statuses = [\"pending\", \"approved\", \"rejected\", \"missing_documents\"]\n-foreach($statuses as $status)\n-{\n-  $stmt = $conn->prepare(\"SELECT COUNT(*) as count FROM enrollments WHERE status = ?\");\n-  $stmt->bind_param(\"s\", $status);\n-  $stmt->execute();\n-  $stats[$status] = $stmt->get_result()->fetch_assoc()['count'];\n+$stats = [];\n+$statuses = ['pending', 'approved', 'rejected', 'missing_documents'];\n+foreach ($statuses as $status) {\n+    $stmt = $conn->prepare(\"SELECT COUNT(*) as count FROM enrollments WHERE status = ?\");\n+    $stmt->bind_param(\"s\", $status);\n+    $stmt->execute();\n+    $stats[$status] = $stmt->get_result()->fetch_assoc()['count'];\n }\n ?>\n \n <!DOCTYPE html>\n@@ -124,10 +119,9 @@\n     <title>Pending Enrollments - TLGC Admin</title>\n     <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n     <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css\" rel=\"stylesheet\">\n     <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n-    <link rel=\"icon\" href=\"../picture/tlgc_pic.jpg\"\n-type=\"image/x-icon\">\n+    <link rel=\"icon\" href=\"../picture/tlgc_pic.jpg\" type=\"image/x-icon\">\n     <style>\n         body {\n             background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);\n             font-family: 'Segoe UI', sans-serif;\n@@ -168,10 +162,9 @@\n     </style>\n </head>\n <body>\n     <!-- Navigation -->\n-    <nav\n-class=\"navbar navbar-expand-lg navbar-dark py-3\">\n+    <nav class=\"navbar navbar-expand-lg navbar-dark py-3\">\n         <div class=\"container-fluid\">\n             <a class=\"navbar-brand d-flex align-items-center\" href=\"../admin-dashboard.php\">\n                 <img src=\"../../picture/tlgc_pic.jpg\" alt=\"School Logo\" class=\"school-logo\">\n                 TLGC Admin Panel\n@@ -390,9 +383,9 @@\n             this.disabled = true;\n             this.textContent = 'Processing...';\n             \n             // Send AJAX request - UPDATED: changed filename\n-            fetch('process-enrollment.php', {\n+            fetch('process-enrollment-updated.php', {\n                 method: 'POST',\n                 headers: {\n                     'Content-Type': 'application/x-www-form-urlencoded',\n                 },\n@@ -401,22 +394,9 @@\n                     enrollment_id: currentEnrollmentId,\n                     remarks: remarks\n                 })\n             })\n-            .then(response => {\n-                // Add debugging to see what we actually received\n-                if (!response.ok) {\n-                    throw new Error('Server returned status: ' + response.status);\n-                }\n-                \n-                // Check if response is actually JSON\n-                const contentType = response.headers.get('content-type');\n-                if (!contentType || !contentType.includes('application/json')) {\n-                    throw new Error('Server returned non-JSON response');\n-                }\n-                \n-                return response.json();\n-            })\n+            .then(response => response.json())\n             .then(data => {\n                 if (data.success) {\n                     // Show success message\n                     alert(data.message);\n"
                },
                {
                    "date": 1749406815639,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -375,47 +375,63 @@\n             \n             modal.show();\n         }\n \n-        document.getElementById('confirmBtn').addEventListener('click', function() {\n-            const remarks = document.getElementById('remarksInput').value;\n-            \n-            // Show loading state\n-            this.disabled = true;\n-            this.textContent = 'Processing...';\n-            \n-            // Send AJAX request - UPDATED: changed filename\n-            fetch('process-enrollment-updated.php', {\n-                method: 'POST',\n-                headers: {\n-                    'Content-Type': 'application/x-www-form-urlencoded',\n-                },\n-                body: new URLSearchParams({\n-                    action: currentAction,\n-                    enrollment_id: currentEnrollmentId,\n-                    remarks: remarks\n-                })\n-            })\n-            .then(response => response.json())\n-            .then(data => {\n-                if (data.success) {\n-                    // Show success message\n-                    alert(data.message);\n-                    // Reload page to update the table\n-                    location.reload();\n-                } else {\n-                    alert('Error: ' + data.message);\n-                    // Reset button\n-                    this.disabled = false;\n-                    this.textContent = 'Confirm';\n-                }\n-            })\n-            .catch(error => {\n-                alert('Error: ' + error.message);\n-                // Reset button\n-                this.disabled = false;\n-                this.textContent = 'Confirm';\n-            });\n-        });\n+const currentAction = \"\" // Declare currentAction variable\n+const currentEnrollmentId = \"\" // Declare currentEnrollmentId variable\n+\n+document.getElementById(\"confirmBtn\").addEventListener(\"click\", function () {\n+  const remarks = document.getElementById(\"remarksInput\").value\n+\n+  // Show loading state\n+  this.disabled = true\n+  this.textContent = \"Processing...\"\n+\n+  // FIXED: Make sure the filename matches your actual PHP file\n+  fetch(\"process-enrollment.php\", {\n+    // Changed from 'process-enrollment-updated.php'\n+    method: \"POST\",\n+    headers: {\n+      \"Content-Type\": \"application/x-www-form-urlencoded\",\n+    },\n+    body: new URLSearchParams({\n+      action: currentAction,\n+      enrollment_id: currentEnrollmentId,\n+      remarks: remarks,\n+    }),\n+  })\n+    .then((response) => {\n+      // Add debugging to see what we actually received\n+      console.log(\"Response status:\", response.status)\n+      console.log(\"Response headers:\", response.headers.get(\"content-type\"))\n+\n+      // Check if response is actually JSON\n+      const contentType = response.headers.get(\"content-type\")\n+      if (!contentType || !contentType.includes(\"application/json\")) {\n+        throw new Error(\"Server returned non-JSON response\")\n+      }\n+\n+      return response.json()\n+    })\n+    .then((data) => {\n+      console.log(\"Parsed JSON:\", data) // Debug output\n+\n+      if (data.success) {\n+        alert(data.message)\n+        location.reload()\n+      } else {\n+        alert(\"Error: \" + data.message)\n+        this.disabled = false\n+        this.textContent = \"Confirm\"\n+      }\n+    })\n+    .catch((error) => {\n+      console.error(\"Fetch error:\", error)\n+      alert(\"Error: \" + error.message)\n+      this.disabled = false\n+      this.textContent = \"Confirm\"\n+    })\n+})\n+\n     </script>\n </body>\n </html>\n"
                },
                {
                    "date": 1749406826752,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -375,63 +375,47 @@\n             \n             modal.show();\n         }\n \n-const currentAction = \"\" // Declare currentAction variable\n-const currentEnrollmentId = \"\" // Declare currentEnrollmentId variable\n-\n-document.getElementById(\"confirmBtn\").addEventListener(\"click\", function () {\n-  const remarks = document.getElementById(\"remarksInput\").value\n-\n-  // Show loading state\n-  this.disabled = true\n-  this.textContent = \"Processing...\"\n-\n-  // FIXED: Make sure the filename matches your actual PHP file\n-  fetch(\"process-enrollment.php\", {\n-    // Changed from 'process-enrollment-updated.php'\n-    method: \"POST\",\n-    headers: {\n-      \"Content-Type\": \"application/x-www-form-urlencoded\",\n-    },\n-    body: new URLSearchParams({\n-      action: currentAction,\n-      enrollment_id: currentEnrollmentId,\n-      remarks: remarks,\n-    }),\n-  })\n-    .then((response) => {\n-      // Add debugging to see what we actually received\n-      console.log(\"Response status:\", response.status)\n-      console.log(\"Response headers:\", response.headers.get(\"content-type\"))\n-\n-      // Check if response is actually JSON\n-      const contentType = response.headers.get(\"content-type\")\n-      if (!contentType || !contentType.includes(\"application/json\")) {\n-        throw new Error(\"Server returned non-JSON response\")\n-      }\n-\n-      return response.json()\n-    })\n-    .then((data) => {\n-      console.log(\"Parsed JSON:\", data) // Debug output\n-\n-      if (data.success) {\n-        alert(data.message)\n-        location.reload()\n-      } else {\n-        alert(\"Error: \" + data.message)\n-        this.disabled = false\n-        this.textContent = \"Confirm\"\n-      }\n-    })\n-    .catch((error) => {\n-      console.error(\"Fetch error:\", error)\n-      alert(\"Error: \" + error.message)\n-      this.disabled = false\n-      this.textContent = \"Confirm\"\n-    })\n-})\n-\n+        document.getElementById('confirmBtn').addEventListener('click', function() {\n+            const remarks = document.getElementById('remarksInput').value;\n+            \n+            // Show loading state\n+            this.disabled = true;\n+            this.textContent = 'Processing...';\n+            \n+            // Send AJAX request - UPDATED: changed filename\n+            fetch('process-enrollment-updated.php', {\n+                method: 'POST',\n+                headers: {\n+                    'Content-Type': 'application/x-www-form-urlencoded',\n+                },\n+                body: new URLSearchParams({\n+                    action: currentAction,\n+                    enrollment_id: currentEnrollmentId,\n+                    remarks: remarks\n+                })\n+            })\n+            .then(response => response.json())\n+            .then(data => {\n+                if (data.success) {\n+                    // Show success message\n+                    alert(data.message);\n+                    // Reload page to update the table\n+                    location.reload();\n+                } else {\n+                    alert('Error: ' + data.message);\n+                    // Reset button\n+                    this.disabled = false;\n+                    this.textContent = 'Confirm';\n+                }\n+            })\n+            .catch(error => {\n+                alert('Error: ' + error.message);\n+                // Reset button\n+                this.disabled = false;\n+                this.textContent = 'Confirm';\n+            });\n+        });\n     </script>\n </body>\n </html>\n"
                },
                {
                    "date": 1749407047495,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -337,85 +337,96 @@\n             </div>\n         </div>\n     </div>\n \n-    <script>\n-        let currentEnrollmentId = null;\n-        let currentAction = null;\n+<script>\n+    let currentEnrollmentId = null;\n+    let currentAction = null;\n \n-        function processEnrollment(enrollmentId, action, studentName) {\n-            currentEnrollmentId = enrollmentId;\n-            currentAction = action;\n-            \n-            const modal = new bootstrap.Modal(document.getElementById('actionModal'));\n-            const modalTitle = document.getElementById('modalTitle');\n-            const modalMessage = document.getElementById('modalMessage');\n-            const confirmBtn = document.getElementById('confirmBtn');\n-            \n-            // Set modal content based on action\n-            switch(action) {\n-                case 'approve':\n-                    modalTitle.textContent = 'Approve Enrollment';\n-                    modalMessage.textContent = `Are you sure you want to approve the enrollment for ${studentName}? This will also update their Student ID if needed.`;\n-                    confirmBtn.className = 'btn btn-success';\n-                    confirmBtn.textContent = 'Approve';\n-                    break;\n-                case 'reject':\n-                    modalTitle.textContent = 'Reject Enrollment';\n-                    modalMessage.textContent = `Are you sure you want to reject the enrollment for ${studentName}?`;\n-                    confirmBtn.className = 'btn btn-danger';\n-                    confirmBtn.textContent = 'Reject';\n-                    break;\n-                case 'missing_documents':\n-                    modalTitle.textContent = 'Mark as Missing Documents';\n-                    modalMessage.textContent = `Mark ${studentName}'s enrollment as missing documents?`;\n-                    confirmBtn.className = 'btn btn-warning';\n-                    confirmBtn.textContent = 'Mark as Missing';\n-                    break;\n-            }\n-            \n-            modal.show();\n+    function processEnrollment(enrollmentId, action, studentName) {\n+        currentEnrollmentId = enrollmentId;\n+        currentAction = action;\n+        \n+        const modal = new bootstrap.Modal(document.getElementById('actionModal'));\n+        const modalTitle = document.getElementById('modalTitle');\n+        const modalMessage = document.getElementById('modalMessage');\n+        const confirmBtn = document.getElementById('confirmBtn');\n+        \n+        // Set modal content based on action\n+        switch(action) {\n+            case 'approve':\n+                modalTitle.textContent = 'Approve Enrollment';\n+                modalMessage.textContent = `Are you sure you want to approve the enrollment for ${studentName}? This will also update their Student ID if needed.`;\n+                confirmBtn.className = 'btn btn-success';\n+                confirmBtn.textContent = 'Approve';\n+                break;\n+            case 'reject':\n+                modalTitle.textContent = 'Reject Enrollment';\n+                modalMessage.textContent = `Are you sure you want to reject the enrollment for ${studentName}?`;\n+                confirmBtn.className = 'btn btn-danger';\n+                confirmBtn.textContent = 'Reject';\n+                break;\n+            case 'missing_documents':\n+                modalTitle.textContent = 'Mark as Missing Documents';\n+                modalMessage.textContent = `Mark ${studentName}'s enrollment as missing documents?`;\n+                confirmBtn.className = 'btn btn-warning';\n+                confirmBtn.textContent = 'Mark as Missing';\n+                break;\n         }\n+        \n+        modal.show();\n+    }\n \n-        document.getElementById('confirmBtn').addEventListener('click', function() {\n-            const remarks = document.getElementById('remarksInput').value;\n-            \n-            // Show loading state\n-            this.disabled = true;\n-            this.textContent = 'Processing...';\n-            \n-            // Send AJAX request - UPDATED: changed filename\n-            fetch('process-enrollment-updated.php', {\n-                method: 'POST',\n-                headers: {\n-                    'Content-Type': 'application/x-www-form-urlencoded',\n-                },\n-                body: new URLSearchParams({\n-                    action: currentAction,\n-                    enrollment_id: currentEnrollmentId,\n-                    remarks: remarks\n-                })\n+    document.getElementById('confirmBtn').addEventListener('click', function() {\n+        const remarks = document.getElementById('remarksInput').value;\n+        \n+        // Show loading state\n+        this.disabled = true;\n+        this.textContent = 'Processing...';\n+        \n+        // FIXED: Use the correct filename - use the same file name or create the correct endpoint\n+        fetch(window.location.pathname, {  // This uses the current file\n+            method: 'POST',\n+            headers: {\n+                'Content-Type': 'application/x-www-form-urlencoded',\n+            },\n+            body: new URLSearchParams({\n+                action: currentAction,\n+                enrollment_id: currentEnrollmentId,\n+                remarks: remarks\n             })\n-            .then(response => response.json())\n-            .then(data => {\n+        })\n+        .then(response => {\n+            // FIXED: Check if response is ok and contains JSON\n+            if (!response.ok) {\n+                throw new Error(`HTTP error! status: ${response.status}`);\n+            }\n+            return response.text(); // Get as text first to debug\n+        })\n+        .then(text => {\n+            // FIXED: Try to parse JSON and provide better error handling\n+            try {\n+                const data = JSON.parse(text);\n                 if (data.success) {\n-                    // Show success message\n                     alert(data.message);\n-                    // Reload page to update the table\n                     location.reload();\n                 } else {\n                     alert('Error: ' + data.message);\n-                    // Reset button\n-                    this.disabled = false;\n-                    this.textContent = 'Confirm';\n                 }\n-            })\n-            .catch(error => {\n-                alert('Error: ' + error.message);\n-                // Reset button\n-                this.disabled = false;\n-                this.textContent = 'Confirm';\n-            });\n+            } catch (e) {\n+                console.error('Response was not JSON:', text);\n+                alert('Server error: Invalid response format');\n+            }\n+        })\n+        .catch(error => {\n+            console.error('Fetch error:', error);\n+            alert('Error: ' + error.message);\n+        })\n+        .finally(() => {\n+            // Reset button state\n+            this.disabled = false;\n+            this.textContent = 'Confirm';\n         });\n-    </script>\n+    });\n+</script>\n </body>\n </html>\n"
                },
                {
                    "date": 1749407114505,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -19,9 +19,9 @@\n     \n     try {\n         switch ($action) {\n             case 'approve':\n-                // UPDATED: Get enrollment details first\n+                // Get enrollment details first\n                 $stmt = $conn->prepare(\"\n                     SELECT e.*, s.student_id as current_student_id \n                     FROM enrollments e \n                     JOIN students s ON e.student_id = s.student_id \n@@ -78,8 +78,9 @@\n     } catch (Exception $e) {\n         $response = ['success' => false, 'message' => 'Error: ' . $e->getMessage()];\n     }\n     \n+    // FIXED: Ensure clean JSON output\n     header('Content-Type: application/json');\n     echo json_encode($response);\n     exit();\n }\n"
                },
                {
                    "date": 1749407293864,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n <?php\n session_start();\n include '../../db.php';\n-include 'generate-student-id.php'; // Include ang helper file\n+include 'generate-student-id.php';\n \n // Check admin authentication\n if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n     header(\"Location: ../../logregfor/admin-login.php\");\n@@ -21,71 +21,98 @@\n         switch ($action) {\n             case 'approve':\n                 // Get enrollment details first\n                 $stmt = $conn->prepare(\"\n-                    SELECT e.*, s.student_id as current_student_id \n+                    SELECT e.*, s.student_id as current_student_id, s.first_name, s.last_name\n                     FROM enrollments e \n                     JOIN students s ON e.student_id = s.student_id \n                     WHERE e.id = ?\n                 \");\n                 $stmt->bind_param(\"i\", $enrollmentId);\n                 $stmt->execute();\n                 $enrollment = $stmt->get_result()->fetch_assoc();\n                 \n-                if ($enrollment) {\n-                    // Check if student already has new ID format\n-                    $currentStudentId = $enrollment['current_student_id'];\n-                    $needsNewId = !preg_match('/^TLGC-/', $currentStudentId);\n+                if (!$enrollment) {\n+                    throw new Exception(\"Enrollment not found with ID: \" . $enrollmentId);\n+                }\n+                \n+                $currentStudentId = $enrollment['current_student_id'];\n+                $needsNewId = needsStudentIdUpdate($currentStudentId);\n+                \n+                if ($needsNewId) {\n+                    // Generate new student ID based on program\n+                    $newStudentId = generateStudentId($conn, $enrollment['program']);\n                     \n-                    if ($needsNewId) {\n-                        // Generate new student ID based on program\n-                        $newStudentId = generateStudentId($conn, $enrollment['program']);\n-                        \n-                        // Update student ID in all related tables\n-                        if (updateStudentId($conn, $currentStudentId, $newStudentId)) {\n-                            $message = \"Enrollment approved and Student ID updated to: {$newStudentId}\";\n-                        } else {\n-                            throw new Exception(\"Failed to update Student ID\");\n-                        }\n-                    } else {\n-                        $message = \"Enrollment approved successfully!\";\n+                    // Validate the generated ID\n+                    if (!validateStudentId($newStudentId)) {\n+                        throw new Exception(\"Generated invalid Student ID format: \" . $newStudentId);\n                     }\n                     \n-                    // Update enrollment status\n-                    $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'approved', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n-                    $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n-                    $stmt->execute();\n+                    // Update student ID in all related tables\n+                    if (!updateStudentId($conn, $currentStudentId, $newStudentId)) {\n+                        throw new Exception(\"Failed to update Student ID from {$currentStudentId} to {$newStudentId}. Check database logs for details.\");\n+                    }\n                     \n-                    $response = ['success' => true, 'message' => $message];\n+                    $message = \"Enrollment approved and Student ID updated from {$currentStudentId} to {$newStudentId}\";\n                 } else {\n-                    throw new Exception(\"Enrollment not found\");\n+                    $message = \"Enrollment approved successfully! (Student ID already in correct format)\";\n                 }\n+                \n+                // Update enrollment status\n+                $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'approved', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n+                $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n+                \n+                if (!$stmt->execute()) {\n+                    throw new Exception(\"Failed to update enrollment status: \" . $stmt->error);\n+                }\n+                \n+                $response = ['success' => true, 'message' => $message];\n                 break;\n                 \n             case 'reject':\n                 $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'rejected', processed_by = ?, date_processed = NOW(), rejection_reason = ? WHERE id = ?\");\n                 $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n-                $stmt->execute();\n+                \n+                if (!$stmt->execute()) {\n+                    throw new Exception(\"Failed to reject enrollment: \" . $stmt->error);\n+                }\n+                \n                 $response = ['success' => true, 'message' => 'Enrollment rejected successfully!'];\n                 break;\n                 \n             case 'missing_documents':\n                 $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'missing_documents', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n                 $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n-                $stmt->execute();\n+                \n+                if (!$stmt->execute()) {\n+                    throw new Exception(\"Failed to mark as missing documents: \" . $stmt->error);\n+                }\n+                \n                 $response = ['success' => true, 'message' => 'Marked as missing documents!'];\n                 break;\n+                \n+            default:\n+                throw new Exception(\"Invalid action: \" . $action);\n         }\n+        \n     } catch (Exception $e) {\n-        $response = ['success' => false, 'message' => 'Error: ' . $e->getMessage()];\n+        $response = ['success' => false, 'message' => $e->getMessage()];\n+        \n+        // Log the full error for debugging\n+        error_log(\"Enrollment Processing Error: \" . $e->getMessage() . \" | Enrollment ID: \" . $enrollmentId . \" | Action: \" . $action);\n     }\n     \n-    // FIXED: Ensure clean JSON output\n+    // Ensure clean JSON output\n     header('Content-Type: application/json');\n     echo json_encode($response);\n     exit();\n }\n \n+// If not an AJAX request, redirect or show error\n+header(\"Location: ../admin-dashboard.php\");\n+exit();\n+?>\n+\n // Get pending enrollments with student details\n $stmt = $conn->prepare(\"\n     SELECT \n         e.*,\n"
                },
                {
                    "date": 1749407397486,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -109,10 +109,10 @@\n \n // If not an AJAX request, redirect or show error\n header(\"Location: ../admin-dashboard.php\");\n exit();\n-?>\n \n+\n // Get pending enrollments with student details\n $stmt = $conn->prepare(\"\n     SELECT \n         e.*,\n"
                },
                {
                    "date": 1749407425714,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -106,13 +106,8 @@\n     echo json_encode($response);\n     exit();\n }\n \n-// If not an AJAX request, redirect or show error\n-header(\"Location: ../admin-dashboard.php\");\n-exit();\n-\n-\n // Get pending enrollments with student details\n $stmt = $conn->prepare(\"\n     SELECT \n         e.*,\n@@ -136,8 +131,11 @@\n     $stmt->bind_param(\"s\", $status);\n     $stmt->execute();\n     $stats[$status] = $stmt->get_result()->fetch_assoc()['count'];\n }\n+// If not an AJAX request, redirect or show error\n+header(\"Location: ../admin-dashboard.php\");\n+exit();\n ?>\n \n <!DOCTYPE html>\n <html lang=\"en\">\n"
                },
                {
                    "date": 1749407438275,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -131,11 +131,8 @@\n     $stmt->bind_param(\"s\", $status);\n     $stmt->execute();\n     $stats[$status] = $stmt->get_result()->fetch_assoc()['count'];\n }\n-// If not an AJAX request, redirect or show error\n-header(\"Location: ../admin-dashboard.php\");\n-exit();\n ?>\n \n <!DOCTYPE html>\n <html lang=\"en\">\n"
                },
                {
                    "date": 1749407596910,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n <?php\n session_start();\n include '../../db.php';\n-include 'generate-student-id.php';\n+include 'generate-student-id-fixed.php';\n \n // Check admin authentication\n if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n     header(\"Location: ../../logregfor/admin-login.php\");\n@@ -46,13 +46,27 @@\n                     if (!validateStudentId($newStudentId)) {\n                         throw new Exception(\"Generated invalid Student ID format: \" . $newStudentId);\n                     }\n                     \n-                    // Update student ID in all related tables\n-                    if (!updateStudentId($conn, $currentStudentId, $newStudentId)) {\n-                        throw new Exception(\"Failed to update Student ID from {$currentStudentId} to {$newStudentId}. Check database logs for details.\");\n+                    // Debug the current state\n+                    $debugInfo = debugStudentIdUpdate($conn, $currentStudentId);\n+                    error_log(\"Debug info for student ID {$currentStudentId}: \" . json_encode($debugInfo));\n+                    \n+                    // Try the improved update method first\n+                    $updateSuccess = updateStudentId($conn, $currentStudentId, $newStudentId);\n+                    \n+                    // If that fails, try the migration method\n+                    if (!$updateSuccess) {\n+                        error_log(\"Standard update failed, trying migration method...\");\n+                        $updateSuccess = migrateStudentId($conn, $currentStudentId, $newStudentId);\n                     }\n                     \n+                    if (!$updateSuccess) {\n+                        // Provide detailed error information\n+                        $debugInfo = debugStudentIdUpdate($conn, $currentStudentId);\n+                        throw new Exception(\"Failed to update Student ID. Debug info: \" . json_encode($debugInfo));\n+                    }\n+                    \n                     $message = \"Enrollment approved and Student ID updated from {$currentStudentId} to {$newStudentId}\";\n                 } else {\n                     $message = \"Enrollment approved successfully! (Student ID already in correct format)\";\n                 }\n@@ -95,19 +109,18 @@\n         }\n         \n     } catch (Exception $e) {\n         $response = ['success' => false, 'message' => $e->getMessage()];\n-        \n-        // Log the full error for debugging\n-        error_log(\"Enrollment Processing Error: \" . $e->getMessage() . \" | Enrollment ID: \" . $enrollmentId . \" | Action: \" . $action);\n+        error_log(\"Enrollment Processing Error: \" . $e->getMessage());\n     }\n     \n-    // Ensure clean JSON output\n     header('Content-Type: application/json');\n     echo json_encode($response);\n     exit();\n }\n \n+header(\"Location: ../admin-dashboard.php\");\n+exit();\n // Get pending enrollments with student details\n $stmt = $conn->prepare(\"\n     SELECT \n         e.*,\n"
                },
                {
                    "date": 1749407619595,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n <?php\n session_start();\n include '../../db.php';\n-include 'generate-student-id-fixed.php';\n+include 'generate-student-id.php';\n \n // Check admin authentication\n if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n     header(\"Location: ../../logregfor/admin-login.php\");\n@@ -46,27 +46,13 @@\n                     if (!validateStudentId($newStudentId)) {\n                         throw new Exception(\"Generated invalid Student ID format: \" . $newStudentId);\n                     }\n                     \n-                    // Debug the current state\n-                    $debugInfo = debugStudentIdUpdate($conn, $currentStudentId);\n-                    error_log(\"Debug info for student ID {$currentStudentId}: \" . json_encode($debugInfo));\n-                    \n-                    // Try the improved update method first\n-                    $updateSuccess = updateStudentId($conn, $currentStudentId, $newStudentId);\n-                    \n-                    // If that fails, try the migration method\n-                    if (!$updateSuccess) {\n-                        error_log(\"Standard update failed, trying migration method...\");\n-                        $updateSuccess = migrateStudentId($conn, $currentStudentId, $newStudentId);\n+                    // Update student ID in all related tables\n+                    if (!updateStudentId($conn, $currentStudentId, $newStudentId)) {\n+                        throw new Exception(\"Failed to update Student ID from {$currentStudentId} to {$newStudentId}. Check database logs for details.\");\n                     }\n                     \n-                    if (!$updateSuccess) {\n-                        // Provide detailed error information\n-                        $debugInfo = debugStudentIdUpdate($conn, $currentStudentId);\n-                        throw new Exception(\"Failed to update Student ID. Debug info: \" . json_encode($debugInfo));\n-                    }\n-                    \n                     $message = \"Enrollment approved and Student ID updated from {$currentStudentId} to {$newStudentId}\";\n                 } else {\n                     $message = \"Enrollment approved successfully! (Student ID already in correct format)\";\n                 }\n@@ -109,18 +95,19 @@\n         }\n         \n     } catch (Exception $e) {\n         $response = ['success' => false, 'message' => $e->getMessage()];\n-        error_log(\"Enrollment Processing Error: \" . $e->getMessage());\n+        \n+        // Log the full error for debugging\n+        error_log(\"Enrollment Processing Error: \" . $e->getMessage() . \" | Enrollment ID: \" . $enrollmentId . \" | Action: \" . $action);\n     }\n     \n+    // Ensure clean JSON output\n     header('Content-Type: application/json');\n     echo json_encode($response);\n     exit();\n }\n \n-header(\"Location: ../admin-dashboard.php\");\n-exit();\n // Get pending enrollments with student details\n $stmt = $conn->prepare(\"\n     SELECT \n         e.*,\n"
                },
                {
                    "date": 1749408328271,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n <?php\n session_start();\n include '../../db.php';\n-include 'generate-student-id.php';\n+include 'generate-student-id-fixed.php';\n \n // Check admin authentication\n if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n     header(\"Location: ../../logregfor/admin-login.php\");\n@@ -21,9 +21,9 @@\n         switch ($action) {\n             case 'approve':\n                 // Get enrollment details first\n                 $stmt = $conn->prepare(\"\n-                    SELECT e.*, s.student_id as current_student_id, s.first_name, s.last_name\n+                    SELECT e.*, s.student_id, s.formatted_id, s.first_name, s.last_name\n                     FROM enrollments e \n                     JOIN students s ON e.student_id = s.student_id \n                     WHERE e.id = ?\n                 \");\n@@ -34,28 +34,28 @@\n                 if (!$enrollment) {\n                     throw new Exception(\"Enrollment not found with ID: \" . $enrollmentId);\n                 }\n                 \n-                $currentStudentId = $enrollment['current_student_id'];\n-                $needsNewId = needsStudentIdUpdate($currentStudentId);\n+                $studentId = $enrollment['student_id'];\n+                $needsFormattedId = needsFormattedId($conn, $studentId);\n                 \n-                if ($needsNewId) {\n-                    // Generate new student ID based on program\n-                    $newStudentId = generateStudentId($conn, $enrollment['program']);\n+                if ($needsFormattedId) {\n+                    // Generate formatted ID based on program\n+                    $formattedId = generateFormattedId($conn, $enrollment['program'], $studentId);\n                     \n                     // Validate the generated ID\n-                    if (!validateStudentId($newStudentId)) {\n-                        throw new Exception(\"Generated invalid Student ID format: \" . $newStudentId);\n+                    if (!validateFormattedId($formattedId)) {\n+                        throw new Exception(\"Generated invalid formatted ID: \" . $formattedId);\n                     }\n                     \n-                    // Update student ID in all related tables\n-                    if (!updateStudentId($conn, $currentStudentId, $newStudentId)) {\n-                        throw new Exception(\"Failed to update Student ID from {$currentStudentId} to {$newStudentId}. Check database logs for details.\");\n+                    // Update student's formatted ID\n+                    if (!updateFormattedId($conn, $studentId, $formattedId)) {\n+                        throw new Exception(\"Failed to update formatted ID for student: \" . $studentId);\n                     }\n                     \n-                    $message = \"Enrollment approved and Student ID updated from {$currentStudentId} to {$newStudentId}\";\n+                    $message = \"Enrollment approved and Student ID formatted as: {$formattedId}\";\n                 } else {\n-                    $message = \"Enrollment approved successfully! (Student ID already in correct format)\";\n+                    $message = \"Enrollment approved successfully!\";\n                 }\n                 \n                 // Update enrollment status\n                 $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'approved', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n@@ -95,14 +95,11 @@\n         }\n         \n     } catch (Exception $e) {\n         $response = ['success' => false, 'message' => $e->getMessage()];\n-        \n-        // Log the full error for debugging\n-        error_log(\"Enrollment Processing Error: \" . $e->getMessage() . \" | Enrollment ID: \" . $enrollmentId . \" | Action: \" . $action);\n+        error_log(\"Enrollment Processing Error: \" . $e->getMessage());\n     }\n     \n-    // Ensure clean JSON output\n     header('Content-Type: application/json');\n     echo json_encode($response);\n     exit();\n }\n@@ -113,9 +110,10 @@\n         e.*,\n         CONCAT(s.first_name, ' ', s.last_name) as student_name,\n         s.email as student_email,\n         s.contact_number,\n-        s.student_id as current_student_id\n+        s.student_id,\n+        s.formatted_id\n     FROM enrollments e \n     LEFT JOIN students s ON e.student_id = s.student_id\n     WHERE e.status = 'pending'\n     ORDER BY e.date_submitted DESC\n@@ -264,9 +262,9 @@\n                                 <table class=\"table table-hover mb-0\">\n                                     <thead class=\"table-light\">\n                                         <tr>\n                                             <th>Student</th>\n-                                            <th>Current ID</th>\n+                                            <th>ID</th>\n                                             <th>Program</th>\n                                             <th>Year & Section</th>\n                                             <th>Contact</th>\n                                             <th>Date Submitted</th>\n@@ -275,30 +273,30 @@\n                                     </thead>\n                                     <tbody>\n                                         <?php foreach ($pendingEnrollments as $enrollment): ?>\n                                         <?php \n-                                            // Preview what the new student ID will be\n-                                            $previewId = generateStudentId($conn, $enrollment['program']);\n-                                            $needsNewId = !preg_match('/^TLGC-/', $enrollment['current_student_id']);\n+                                            // Preview what the formatted ID will be\n+                                            $previewId = generateFormattedId($conn, $enrollment['program'], $enrollment['student_id']);\n+                                            $needsFormattedId = empty($enrollment['formatted_id']);\n                                         ?>\n                                         <tr>\n                                             <td>\n                                                 <div>\n                                                     <strong><?= htmlspecialchars($enrollment['student_name'] ?: 'Student ID: ' . $enrollment['student_id']) ?></strong>\n                                                     <br>\n-                                                    <small class=\"text-muted\">ID: <?= htmlspecialchars($enrollment['student_id']) ?></small>\n+                                                    <small class=\"text-muted\">System ID: <?= htmlspecialchars($enrollment['student_id']) ?></small>\n                                                 </div>\n                                             </td>\n                                             <td>\n                                                 <div class=\"student-id-preview\">\n-                                                    <?= htmlspecialchars($enrollment['current_student_id']) ?>\n+                                                    <?= htmlspecialchars($enrollment['formatted_id'] ?: $enrollment['student_id']) ?>\n                                                 </div>\n-                                                <?php if ($needsNewId): ?>\n+                                                <?php if ($needsFormattedId): ?>\n                                                     <small class=\"id-will-change\">\n                                                         <i class=\"bi bi-arrow-right\"></i> Will become: <strong><?= $previewId ?></strong>\n                                                     </small>\n                                                 <?php else: ?>\n-                                                    <small class=\"text-muted\"> Already has new format</small>\n+                                                    <small class=\"text-muted\"> Already formatted</small>\n                                                 <?php endif; ?>\n                                             </td>\n                                             <td><?= htmlspecialchars($enrollment['program']) ?></td>\n                                             <td>\n@@ -313,10 +311,10 @@\n                                             <td>\n                                                 <div class=\"btn-group-vertical btn-group-sm\">\n                                                     <button class=\"btn btn-success btn-sm\" onclick=\"processEnrollment(<?= $enrollment['id'] ?>, 'approve', '<?= htmlspecialchars($enrollment['student_name']) ?>')\">\n                                                         <i class=\"bi bi-check-circle me-1\"></i>Approve\n-                                                        <?php if ($needsNewId): ?>\n-                                                            <br><small>& Update ID</small>\n+                                                        <?php if ($needsFormattedId): ?>\n+                                                            <br><small>& Format ID</small>\n                                                         <?php endif; ?>\n                                                     </button>\n                                                     <button class=\"btn btn-warning btn-sm\" onclick=\"processEnrollment(<?= $enrollment['id'] ?>, 'missing_documents', '<?= htmlspecialchars($enrollment['student_name']) ?>')\">\n                                                         <i class=\"bi bi-exclamation-triangle me-1\"></i>Missing Docs\n@@ -377,9 +375,9 @@\n         // Set modal content based on action\n         switch(action) {\n             case 'approve':\n                 modalTitle.textContent = 'Approve Enrollment';\n-                modalMessage.textContent = `Are you sure you want to approve the enrollment for ${studentName}? This will also update their Student ID if needed.`;\n+                modalMessage.textContent = `Are you sure you want to approve the enrollment for ${studentName}? This will also format their Student ID if needed.`;\n                 confirmBtn.className = 'btn btn-success';\n                 confirmBtn.textContent = 'Approve';\n                 break;\n             case 'reject':\n@@ -405,10 +403,9 @@\n         // Show loading state\n         this.disabled = true;\n         this.textContent = 'Processing...';\n         \n-        // FIXED: Use the correct filename - use the same file name or create the correct endpoint\n-        fetch(window.location.pathname, {  // This uses the current file\n+        fetch(window.location.pathname, {\n             method: 'POST',\n             headers: {\n                 'Content-Type': 'application/x-www-form-urlencoded',\n             },\n@@ -418,16 +415,14 @@\n                 remarks: remarks\n             })\n         })\n         .then(response => {\n-            // FIXED: Check if response is ok and contains JSON\n             if (!response.ok) {\n                 throw new Error(`HTTP error! status: ${response.status}`);\n             }\n-            return response.text(); // Get as text first to debug\n+            return response.text();\n         })\n         .then(text => {\n-            // FIXED: Try to parse JSON and provide better error handling\n             try {\n                 const data = JSON.parse(text);\n                 if (data.success) {\n                     alert(data.message);\n"
                },
                {
                    "date": 1749408516693,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,14 @@\n <?php\n session_start();\n include '../../db.php';\n+\n+// Check if the formatted_id column exists, if not, add it\n+$checkColumn = $conn->query(\"SHOW COLUMNS FROM students LIKE 'formatted_id'\");\n+if ($checkColumn->num_rows == 0) {\n+    $conn->query(\"ALTER TABLE students ADD COLUMN formatted_id VARCHAR(20) NULL\");\n+}\n+\n include 'generate-student-id-fixed.php';\n \n // Check admin authentication\n if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n"
                },
                {
                    "date": 1749408926878,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,11 +5,13 @@\n // Check if the formatted_id column exists, if not, add it\n $checkColumn = $conn->query(\"SHOW COLUMNS FROM students LIKE 'formatted_id'\");\n if ($checkColumn->num_rows == 0) {\n     $conn->query(\"ALTER TABLE students ADD COLUMN formatted_id VARCHAR(20) NULL\");\n+    error_log(\"Added formatted_id column to students table\");\n }\n \n-include 'generate-student-id-fixed.php';\n+// Include the helper file - make sure this file exists in the same directory\n+include_once 'generate-student-id-fixed.php';\n \n // Check admin authentication\n if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n     header(\"Location: ../../logregfor/admin-login.php\");\n@@ -28,9 +30,9 @@\n         switch ($action) {\n             case 'approve':\n                 // Get enrollment details first\n                 $stmt = $conn->prepare(\"\n-                    SELECT e.*, s.student_id, s.formatted_id, s.first_name, s.last_name\n+                    SELECT e.*, s.student_id, s.first_name, s.last_name\n                     FROM enrollments e \n                     JOIN students s ON e.student_id = s.student_id \n                     WHERE e.id = ?\n                 \");\n@@ -117,10 +119,9 @@\n         e.*,\n         CONCAT(s.first_name, ' ', s.last_name) as student_name,\n         s.email as student_email,\n         s.contact_number,\n-        s.student_id,\n-        s.formatted_id\n+        s.student_id\n     FROM enrollments e \n     LEFT JOIN students s ON e.student_id = s.student_id\n     WHERE e.status = 'pending'\n     ORDER BY e.date_submitted DESC\n@@ -282,9 +283,17 @@\n                                         <?php foreach ($pendingEnrollments as $enrollment): ?>\n                                         <?php \n                                             // Preview what the formatted ID will be\n                                             $previewId = generateFormattedId($conn, $enrollment['program'], $enrollment['student_id']);\n-                                            $needsFormattedId = empty($enrollment['formatted_id']);\n+                                            $needsFormattedId = needsFormattedId($conn, $enrollment['student_id']);\n+                                            \n+                                            // Get the current formatted ID if it exists\n+                                            $stmt = $conn->prepare(\"SELECT formatted_id FROM students WHERE student_id = ?\");\n+                                            $stmt->bind_param(\"i\", $enrollment['student_id']);\n+                                            $stmt->execute();\n+                                            $result = $stmt->get_result();\n+                                            $row = $result->fetch_assoc();\n+                                            $formattedId = $row['formatted_id'] ?? '';\n                                         ?>\n                                         <tr>\n                                             <td>\n                                                 <div>\n@@ -294,9 +303,9 @@\n                                                 </div>\n                                             </td>\n                                             <td>\n                                                 <div class=\"student-id-preview\">\n-                                                    <?= htmlspecialchars($enrollment['formatted_id'] ?: $enrollment['student_id']) ?>\n+                                                    <?= htmlspecialchars($formattedId ?: $enrollment['student_id']) ?>\n                                                 </div>\n                                                 <?php if ($needsFormattedId): ?>\n                                                     <small class=\"id-will-change\">\n                                                         <i class=\"bi bi-arrow-right\"></i> Will become: <strong><?= $previewId ?></strong>\n"
                },
                {
                    "date": 1749410057156,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -462,5 +462,5 @@\n         });\n     });\n </script>\n </body>\n-</html>\n+</html>\n\\ No newline at end of file\n"
                },
                {
                    "date": 1749410136910,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,18 +1,9 @@\n <?php\n session_start();\n include '../../db.php';\n+include 'generate-student-id.php';\n \n-// Check if the formatted_id column exists, if not, add it\n-$checkColumn = $conn->query(\"SHOW COLUMNS FROM students LIKE 'formatted_id'\");\n-if ($checkColumn->num_rows == 0) {\n-    $conn->query(\"ALTER TABLE students ADD COLUMN formatted_id VARCHAR(20) NULL\");\n-    error_log(\"Added formatted_id column to students table\");\n-}\n-\n-// Include the helper file - make sure this file exists in the same directory\n-include_once 'generate-student-id-fixed.php';\n-\n // Check admin authentication\n if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n     header(\"Location: ../../logregfor/admin-login.php\");\n     exit();\n@@ -30,9 +21,9 @@\n         switch ($action) {\n             case 'approve':\n                 // Get enrollment details first\n                 $stmt = $conn->prepare(\"\n-                    SELECT e.*, s.student_id, s.first_name, s.last_name\n+                    SELECT e.*, s.student_id as current_student_id, s.first_name, s.last_name\n                     FROM enrollments e \n                     JOIN students s ON e.student_id = s.student_id \n                     WHERE e.id = ?\n                 \");\n@@ -43,28 +34,28 @@\n                 if (!$enrollment) {\n                     throw new Exception(\"Enrollment not found with ID: \" . $enrollmentId);\n                 }\n                 \n-                $studentId = $enrollment['student_id'];\n-                $needsFormattedId = needsFormattedId($conn, $studentId);\n+                $currentStudentId = $enrollment['current_student_id'];\n+                $needsNewId = needsStudentIdUpdate($currentStudentId);\n                 \n-                if ($needsFormattedId) {\n-                    // Generate formatted ID based on program\n-                    $formattedId = generateFormattedId($conn, $enrollment['program'], $studentId);\n+                if ($needsNewId) {\n+                    // Generate new student ID based on program\n+                    $newStudentId = generateStudentId($conn, $enrollment['program']);\n                     \n                     // Validate the generated ID\n-                    if (!validateFormattedId($formattedId)) {\n-                        throw new Exception(\"Generated invalid formatted ID: \" . $formattedId);\n+                    if (!validateStudentId($newStudentId)) {\n+                        throw new Exception(\"Generated invalid Student ID format: \" . $newStudentId);\n                     }\n                     \n-                    // Update student's formatted ID\n-                    if (!updateFormattedId($conn, $studentId, $formattedId)) {\n-                        throw new Exception(\"Failed to update formatted ID for student: \" . $studentId);\n+                    // Update student ID in all related tables\n+                    if (!updateStudentId($conn, $currentStudentId, $newStudentId)) {\n+                        throw new Exception(\"Failed to update Student ID from {$currentStudentId} to {$newStudentId}. Check database logs for details.\");\n                     }\n                     \n-                    $message = \"Enrollment approved and Student ID formatted as: {$formattedId}\";\n+                    $message = \"Enrollment approved and Student ID updated from {$currentStudentId} to {$newStudentId}\";\n                 } else {\n-                    $message = \"Enrollment approved successfully!\";\n+                    $message = \"Enrollment approved successfully! (Student ID already in correct format)\";\n                 }\n                 \n                 // Update enrollment status\n                 $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'approved', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n@@ -104,24 +95,29 @@\n         }\n         \n     } catch (Exception $e) {\n         $response = ['success' => false, 'message' => $e->getMessage()];\n-        error_log(\"Enrollment Processing Error: \" . $e->getMessage());\n+        \n+        // Log the full error for debugging\n+        error_log(\"Enrollment Processing Error: \" . $e->getMessage() . \" | Enrollment ID: \" . $enrollmentId . \" | Action: \" . $action);\n     }\n     \n+    // Ensure clean JSON output\n     header('Content-Type: application/json');\n     echo json_encode($response);\n     exit();\n }\n \n+\n+\n // Get pending enrollments with student details\n $stmt = $conn->prepare(\"\n     SELECT \n         e.*,\n         CONCAT(s.first_name, ' ', s.last_name) as student_name,\n         s.email as student_email,\n         s.contact_number,\n-        s.student_id\n+        s.student_id as current_student_id\n     FROM enrollments e \n     LEFT JOIN students s ON e.student_id = s.student_id\n     WHERE e.status = 'pending'\n     ORDER BY e.date_submitted DESC\n@@ -270,9 +266,9 @@\n                                 <table class=\"table table-hover mb-0\">\n                                     <thead class=\"table-light\">\n                                         <tr>\n                                             <th>Student</th>\n-                                            <th>ID</th>\n+                                            <th>Current ID</th>\n                                             <th>Program</th>\n                                             <th>Year & Section</th>\n                                             <th>Contact</th>\n                                             <th>Date Submitted</th>\n@@ -281,38 +277,30 @@\n                                     </thead>\n                                     <tbody>\n                                         <?php foreach ($pendingEnrollments as $enrollment): ?>\n                                         <?php \n-                                            // Preview what the formatted ID will be\n-                                            $previewId = generateFormattedId($conn, $enrollment['program'], $enrollment['student_id']);\n-                                            $needsFormattedId = needsFormattedId($conn, $enrollment['student_id']);\n-                                            \n-                                            // Get the current formatted ID if it exists\n-                                            $stmt = $conn->prepare(\"SELECT formatted_id FROM students WHERE student_id = ?\");\n-                                            $stmt->bind_param(\"i\", $enrollment['student_id']);\n-                                            $stmt->execute();\n-                                            $result = $stmt->get_result();\n-                                            $row = $result->fetch_assoc();\n-                                            $formattedId = $row['formatted_id'] ?? '';\n+                                            // Preview what the new student ID will be\n+                                            $previewId = generateStudentId($conn, $enrollment['program']);\n+                                            $needsNewId = !preg_match('/^TLGC-/', $enrollment['current_student_id']);\n                                         ?>\n                                         <tr>\n                                             <td>\n                                                 <div>\n                                                     <strong><?= htmlspecialchars($enrollment['student_name'] ?: 'Student ID: ' . $enrollment['student_id']) ?></strong>\n                                                     <br>\n-                                                    <small class=\"text-muted\">System ID: <?= htmlspecialchars($enrollment['student_id']) ?></small>\n+                                                    <small class=\"text-muted\">ID: <?= htmlspecialchars($enrollment['student_id']) ?></small>\n                                                 </div>\n                                             </td>\n                                             <td>\n                                                 <div class=\"student-id-preview\">\n-                                                    <?= htmlspecialchars($formattedId ?: $enrollment['student_id']) ?>\n+                                                    <?= htmlspecialchars($enrollment['current_student_id']) ?>\n                                                 </div>\n-                                                <?php if ($needsFormattedId): ?>\n+                                                <?php if ($needsNewId): ?>\n                                                     <small class=\"id-will-change\">\n                                                         <i class=\"bi bi-arrow-right\"></i> Will become: <strong><?= $previewId ?></strong>\n                                                     </small>\n                                                 <?php else: ?>\n-                                                    <small class=\"text-muted\"> Already formatted</small>\n+                                                    <small class=\"text-muted\"> Already has new format</small>\n                                                 <?php endif; ?>\n                                             </td>\n                                             <td><?= htmlspecialchars($enrollment['program']) ?></td>\n                                             <td>\n@@ -327,10 +315,10 @@\n                                             <td>\n                                                 <div class=\"btn-group-vertical btn-group-sm\">\n                                                     <button class=\"btn btn-success btn-sm\" onclick=\"processEnrollment(<?= $enrollment['id'] ?>, 'approve', '<?= htmlspecialchars($enrollment['student_name']) ?>')\">\n                                                         <i class=\"bi bi-check-circle me-1\"></i>Approve\n-                                                        <?php if ($needsFormattedId): ?>\n-                                                            <br><small>& Format ID</small>\n+                                                        <?php if ($needsNewId): ?>\n+                                                            <br><small>& Update ID</small>\n                                                         <?php endif; ?>\n                                                     </button>\n                                                     <button class=\"btn btn-warning btn-sm\" onclick=\"processEnrollment(<?= $enrollment['id'] ?>, 'missing_documents', '<?= htmlspecialchars($enrollment['student_name']) ?>')\">\n                                                         <i class=\"bi bi-exclamation-triangle me-1\"></i>Missing Docs\n@@ -391,9 +379,9 @@\n         // Set modal content based on action\n         switch(action) {\n             case 'approve':\n                 modalTitle.textContent = 'Approve Enrollment';\n-                modalMessage.textContent = `Are you sure you want to approve the enrollment for ${studentName}? This will also format their Student ID if needed.`;\n+                modalMessage.textContent = `Are you sure you want to approve the enrollment for ${studentName}? This will also update their Student ID if needed.`;\n                 confirmBtn.className = 'btn btn-success';\n                 confirmBtn.textContent = 'Approve';\n                 break;\n             case 'reject':\n@@ -419,9 +407,10 @@\n         // Show loading state\n         this.disabled = true;\n         this.textContent = 'Processing...';\n         \n-        fetch(window.location.pathname, {\n+        // FIXED: Use the correct filename - use the same file name or create the correct endpoint\n+        fetch(window.location.pathname, {  // This uses the current file\n             method: 'POST',\n             headers: {\n                 'Content-Type': 'application/x-www-form-urlencoded',\n             },\n@@ -431,14 +420,16 @@\n                 remarks: remarks\n             })\n         })\n         .then(response => {\n+            // FIXED: Check if response is ok and contains JSON\n             if (!response.ok) {\n                 throw new Error(`HTTP error! status: ${response.status}`);\n             }\n-            return response.text();\n+            return response.text(); // Get as text first to debug\n         })\n         .then(text => {\n+            // FIXED: Try to parse JSON and provide better error handling\n             try {\n                 const data = JSON.parse(text);\n                 if (data.success) {\n                     alert(data.message);\n@@ -462,5 +453,5 @@\n         });\n     });\n </script>\n </body>\n-</html>\n\\ No newline at end of file\n+</html>\n"
                },
                {
                    "date": 1749410158858,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -106,10 +106,8 @@\n     echo json_encode($response);\n     exit();\n }\n \n-\n-\n // Get pending enrollments with student details\n $stmt = $conn->prepare(\"\n     SELECT \n         e.*,\n"
                },
                {
                    "date": 1749410324818,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -398,8 +398,9 @@\n         }\n         \n         modal.show();\n     }\n+\n     document.getElementById('confirmBtn').addEventListener('click', function() {\n         const remarks = document.getElementById('remarksInput').value;\n         \n         // Show loading state\n"
                },
                {
                    "date": 1749410593164,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -119,9 +119,9 @@\n     <title>Pending Enrollments - TLGC Admin</title>\n     <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n     <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css\" rel=\"stylesheet\">\n     <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n-    <link rel=\"icon\" href=\"../picture/tlgc_pic.jpg\" type=\"image/x-icon\">\n+    \n     <style>\n         body {\n             background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);\n             font-family: 'Segoe UI', sans-serif;\n"
                }
            ],
            "date": 1749397660351,
            "name": "Commit-0",
            "content": "<?php\nsession_start();\ninclude '../../db.php';\ninclude 'generate-student-id.php'; // Include ang helper file\n\n// Check admin authentication\nif (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n    header(\"Location: ../../logregfor/admin-login.php\");\n    exit();\n}\n\n// Handle AJAX requests for enrollment actions\nif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {\n    $enrollmentId = $_POST['enrollment_id'] ?? 0;\n    $action = $_POST['action'];\n    $remarks = $_POST['remarks'] ?? '';\n    \n    $response = ['success' => false, 'message' => ''];\n    \n    try {\n        switch ($action) {\n            case 'approve':\n                // UPDATED: Get enrollment details first\n                $stmt = $conn->prepare(\"\n                    SELECT e.*, s.student_id as current_student_id \n                    FROM enrollments e \n                    JOIN students s ON e.student_id = s.student_id \n                    WHERE e.id = ?\n                \");\n                $stmt->bind_param(\"i\", $enrollmentId);\n                $stmt->execute();\n                $enrollment = $stmt->get_result()->fetch_assoc();\n                \n                if ($enrollment) {\n                    // Check if student already has new ID format\n                    $currentStudentId = $enrollment['current_student_id'];\n                    $needsNewId = !preg_match('/^TLGC-/', $currentStudentId);\n                    \n                    if ($needsNewId) {\n                        // Generate new student ID based on program\n                        $newStudentId = generateStudentId($conn, $enrollment['program']);\n                        \n                        // Update student ID in all related tables\n                        if (updateStudentId($conn, $currentStudentId, $newStudentId)) {\n                            $message = \"Enrollment approved and Student ID updated to: {$newStudentId}\";\n                        } else {\n                            throw new Exception(\"Failed to update Student ID\");\n                        }\n                    } else {\n                        $message = \"Enrollment approved successfully!\";\n                    }\n                    \n                    // Update enrollment status\n                    $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'approved', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n                    $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                    $stmt->execute();\n                    \n                    $response = ['success' => true, 'message' => $message];\n                } else {\n                    throw new Exception(\"Enrollment not found\");\n                }\n                break;\n                \n            case 'reject':\n                $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'rejected', processed_by = ?, date_processed = NOW(), rejection_reason = ? WHERE id = ?\");\n                $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                $stmt->execute();\n                $response = ['success' => true, 'message' => 'Enrollment rejected successfully!'];\n                break;\n                \n            case 'missing_documents':\n                $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'missing_documents', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n                $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                $stmt->execute();\n                $response = ['success' => true, 'message' => 'Marked as missing documents!'];\n                break;\n        }\n    } catch (Exception $e) {\n        $response = ['success' => false, 'message' => 'Error: ' . $e->getMessage()];\n    }\n    \n    header('Content-Type: application/json');\n    echo json_encode($response);\n    exit();\n}\n\n// Get pending enrollments with student details\n$stmt = $conn->prepare(\"\n    SELECT \n        e.*,\n        CONCAT(s.first_name, ' ', s.last_name) as student_name,\n        s.email as student_email,\n        s.contact_number,\n        s.student_id as current_student_id\n    FROM enrollments e \n    LEFT JOIN students s ON e.student_id = s.student_id\n    WHERE e.status = 'pending'\n    ORDER BY e.date_submitted DESC\n\");\n$stmt->execute();\n$pendingEnrollments = $stmt->get_result()->fetch_all(MYSQLI_ASSOC);\n\n// Get statistics\n$stats = [];\n$statuses = ['pending', 'approved', 'rejected', 'missing_documents'];\nforeach ($statuses as $status) {\n    $stmt = $conn->prepare(\"SELECT COUNT(*) as count FROM enrollments WHERE status = ?\");\n    $stmt->bind_param(\"s\", $status);\n    $stmt->execute();\n    $stats[$status] = $stmt->get_result()->fetch_assoc()['count'];\n}\n?>\n\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <title>Pending Enrollments - TLGC Admin</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css\" rel=\"stylesheet\">\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n    <style>\n        body {\n            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);\n            font-family: 'Segoe UI', sans-serif;\n        }\n        .navbar {\n            background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);\n            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n        }\n        .school-logo {\n            width: 50px;\n            height: 50px;\n            object-fit: cover;\n            border-radius: 50%;\n            margin-right: 10px;\n            border: 2px solid #fff;\n        }\n        .stats-card {\n            border-radius: 15px;\n            border: none;\n            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);\n            transition: transform 0.3s ease;\n        }\n        .stats-card:hover {\n            transform: translateY(-5px);\n        }\n        .student-id-preview {\n            font-family: 'Courier New', monospace;\n            background: #f8f9fa;\n            padding: 5px 10px;\n            border-radius: 5px;\n            border: 1px solid #dee2e6;\n            font-size: 0.9em;\n        }\n        .id-will-change {\n            color: #28a745;\n            font-weight: bold;\n        }\n    </style>\n</head>\n<body>\n    <!-- Navigation -->\n    <nav class=\"navbar navbar-expand-lg navbar-dark py-3\">\n        <div class=\"container-fluid\">\n            <a class=\"navbar-brand d-flex align-items-center\" href=\"../admin-dashboard.php\">\n                <img src=\"../../picture/tlgc_pic.jpg\" alt=\"School Logo\" class=\"school-logo\">\n                TLGC Admin Panel\n            </a>\n            <div class=\"navbar-nav ms-auto\">\n                <a class=\"nav-link\" href=\"../admin-dashboard.php\">\n                    <i class=\"bi bi-arrow-left me-1\"></i>Back to Dashboard\n                </a>\n            </div>\n        </div>\n    </nav>\n\n    <div class=\"container-fluid py-4\">\n        <!-- Page Header -->\n        <div class=\"row mb-4\">\n            <div class=\"col-12\">\n                <h2 class=\"mb-1\">Pending Enrollments</h2>\n                <p class=\"text-muted\">Review and process student enrollment requests</p>\n            </div>\n        </div>\n\n        <!-- Statistics Cards -->\n        <div class=\"row mb-4\">\n            <div class=\"col-lg-3 col-md-6 mb-3\">\n                <div class=\"card stats-card bg-warning text-white\">\n                    <div class=\"card-body text-center\">\n                        <h3><?= $stats['pending'] ?></h3>\n                        <p class=\"mb-0\">Pending</p>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-lg-3 col-md-6 mb-3\">\n                <div class=\"card stats-card bg-success text-white\">\n                    <div class=\"card-body text-center\">\n                        <h3><?= $stats['approved'] ?></h3>\n                        <p class=\"mb-0\">Approved</p>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-lg-3 col-md-6 mb-3\">\n                <div class=\"card stats-card bg-danger text-white\">\n                    <div class=\"card-body text-center\">\n                        <h3><?= $stats['rejected'] ?></h3>\n                        <p class=\"mb-0\">Rejected</p>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-lg-3 col-md-6 mb-3\">\n                <div class=\"card stats-card bg-info text-white\">\n                    <div class=\"card-body text-center\">\n                        <h3><?= $stats['missing_documents'] ?></h3>\n                        <p class=\"mb-0\">Missing Documents</p>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <!-- Enrollments Table -->\n        <div class=\"row\">\n            <div class=\"col-12\">\n                <div class=\"card\">\n                    <div class=\"card-header\">\n                        <h5 class=\"mb-0\">Pending Enrollment Requests</h5>\n                    </div>\n                    <div class=\"card-body p-0\">\n                        <?php if (empty($pendingEnrollments)): ?>\n                            <div class=\"text-center py-5\">\n                                <i class=\"bi bi-inbox display-1 text-muted\"></i>\n                                <h4 class=\"text-muted mt-3\">No Pending Enrollments</h4>\n                                <p class=\"text-muted\">All enrollment requests have been processed.</p>\n                            </div>\n                        <?php else: ?>\n                            <div class=\"table-responsive\">\n                                <table class=\"table table-hover mb-0\">\n                                    <thead class=\"table-light\">\n                                        <tr>\n                                            <th>Student</th>\n                                            <th>Current ID</th>\n                                            <th>Program</th>\n                                            <th>Year & Section</th>\n                                            <th>Contact</th>\n                                            <th>Date Submitted</th>\n                                            <th>Actions</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                        <?php foreach ($pendingEnrollments as $enrollment): ?>\n                                        <?php \n                                            // Preview what the new student ID will be\n                                            $previewId = generateStudentId($conn, $enrollment['program']);\n                                            $needsNewId = !preg_match('/^TLGC-/', $enrollment['current_student_id']);\n                                        ?>\n                                        <tr>\n                                            <td>\n                                                <div>\n                                                    <strong><?= htmlspecialchars($enrollment['student_name'] ?: 'Student ID: ' . $enrollment['student_id']) ?></strong>\n                                                    <br>\n                                                    <small class=\"text-muted\">ID: <?= htmlspecialchars($enrollment['student_id']) ?></small>\n                                                </div>\n                                            </td>\n                                            <td>\n                                                <div class=\"student-id-preview\">\n                                                    <?= htmlspecialchars($enrollment['current_student_id']) ?>\n                                                </div>\n                                                <?php if ($needsNewId): ?>\n                                                    <small class=\"id-will-change\">\n                                                        <i class=\"bi bi-arrow-right\"></i> Will become: <strong><?= $previewId ?></strong>\n                                                    </small>\n                                                <?php else: ?>\n                                                    <small class=\"text-muted\"> Already has new format</small>\n                                                <?php endif; ?>\n                                            </td>\n                                            <td><?= htmlspecialchars($enrollment['program']) ?></td>\n                                            <td>\n                                                <?= htmlspecialchars($enrollment['year_level']) ?><br>\n                                                <small class=\"text-muted\">Section: <?= htmlspecialchars($enrollment['section']) ?></small>\n                                            </td>\n                                            <td>\n                                                <?= htmlspecialchars($enrollment['student_email'] ?: 'N/A') ?><br>\n                                                <small class=\"text-muted\"><?= htmlspecialchars($enrollment['contact_number'] ?: 'N/A') ?></small>\n                                            </td>\n                                            <td><?= date('M d, Y g:i A', strtotime($enrollment['date_submitted'])) ?></td>\n                                            <td>\n                                                <div class=\"btn-group-vertical btn-group-sm\">\n                                                    <button class=\"btn btn-success btn-sm\" onclick=\"processEnrollment(<?= $enrollment['id'] ?>, 'approve', '<?= htmlspecialchars($enrollment['student_name']) ?>')\">\n                                                        <i class=\"bi bi-check-circle me-1\"></i>Approve\n                                                        <?php if ($needsNewId): ?>\n                                                            <br><small>& Update ID</small>\n                                                        <?php endif; ?>\n                                                    </button>\n                                                    <button class=\"btn btn-warning btn-sm\" onclick=\"processEnrollment(<?= $enrollment['id'] ?>, 'missing_documents', '<?= htmlspecialchars($enrollment['student_name']) ?>')\">\n                                                        <i class=\"bi bi-exclamation-triangle me-1\"></i>Missing Docs\n                                                    </button>\n                                                    <button class=\"btn btn-danger btn-sm\" onclick=\"processEnrollment(<?= $enrollment['id'] ?>, 'reject', '<?= htmlspecialchars($enrollment['student_name']) ?>')\">\n                                                        <i class=\"bi bi-x-circle me-1\"></i>Reject\n                                                    </button>\n                                                </div>\n                                            </td>\n                                        </tr>\n                                        <?php endforeach; ?>\n                                    </tbody>\n                                </table>\n                            </div>\n                        <?php endif; ?>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Action Modal -->\n    <div class=\"modal fade\" id=\"actionModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"modalTitle\">Confirm Action</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <p id=\"modalMessage\"></p>\n                    <div class=\"mb-3\">\n                        <label for=\"remarksInput\" class=\"form-label\">Remarks (Optional)</label>\n                        <textarea class=\"form-control\" id=\"remarksInput\" rows=\"3\" placeholder=\"Add any comments or reasons...\"></textarea>\n                    </div>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancel</button>\n                    <button type=\"button\" class=\"btn btn-primary\" id=\"confirmBtn\">Confirm</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        let currentEnrollmentId = null;\n        let currentAction = null;\n\n        function processEnrollment(enrollmentId, action, studentName) {\n            currentEnrollmentId = enrollmentId;\n            currentAction = action;\n            \n            const modal = new bootstrap.Modal(document.getElementById('actionModal'));\n            const modalTitle = document.getElementById('modalTitle');\n            const modalMessage = document.getElementById('modalMessage');\n            const confirmBtn = document.getElementById('confirmBtn');\n            \n            // Set modal content based on action\n            switch(action) {\n                case 'approve':\n                    modalTitle.textContent = 'Approve Enrollment';\n                    modalMessage.textContent = `Are you sure you want to approve the enrollment for ${studentName}? This will also update their Student ID if needed.`;\n                    confirmBtn.className = 'btn btn-success';\n                    confirmBtn.textContent = 'Approve';\n                    break;\n                case 'reject':\n                    modalTitle.textContent = 'Reject Enrollment';\n                    modalMessage.textContent = `Are you sure you want to reject the enrollment for ${studentName}?`;\n                    confirmBtn.className = 'btn btn-danger';\n                    confirmBtn.textContent = 'Reject';\n                    break;\n                case 'missing_documents':\n                    modalTitle.textContent = 'Mark as Missing Documents';\n                    modalMessage.textContent = `Mark ${studentName}'s enrollment as missing documents?`;\n                    confirmBtn.className = 'btn btn-warning';\n                    confirmBtn.textContent = 'Mark as Missing';\n                    break;\n            }\n            \n            modal.show();\n        }\n\n        document.getElementById('confirmBtn').addEventListener('click', function() {\n            const remarks = document.getElementById('remarksInput').value;\n            \n            // Show loading state\n            this.disabled = true;\n            this.textContent = 'Processing...';\n            \n            // Send AJAX request - UPDATED: changed filename\n            fetch('process-enrollment-updated.php', {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/x-www-form-urlencoded',\n                },\n                body: new URLSearchParams({\n                    action: currentAction,\n                    enrollment_id: currentEnrollmentId,\n                    remarks: remarks\n                })\n            })\n            .then(response => response.json())\n            .then(data => {\n                if (data.success) {\n                    // Show success message\n                    alert(data.message);\n                    // Reload page to update the table\n                    location.reload();\n                } else {\n                    alert('Error: ' + data.message);\n                    // Reset button\n                    this.disabled = false;\n                    this.textContent = 'Confirm';\n                }\n            })\n            .catch(error => {\n                alert('Error: ' + error.message);\n                // Reset button\n                this.disabled = false;\n                this.textContent = 'Confirm';\n            });\n        });\n    </script>\n</body>\n</html>\n"
        }
    ]
}