{
    "sourceFile": "ADMIN/Enrollment_Management/pending-enrollments.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1749397660351,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1749404418345,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -119,8 +119,9 @@\n     <title>Pending Enrollments - TLGC Admin</title>\n     <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n     <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css\" rel=\"stylesheet\">\n     <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n+    <link rel=\"icon\" href=\"../picture/tlgc_pic.jpg\" type=\"image/x-icon\">\n     <style>\n         body {\n             background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);\n             font-family: 'Segoe UI', sans-serif;\n"
                }
            ],
            "date": 1749397660351,
            "name": "Commit-0",
            "content": "<?php\nsession_start();\ninclude '../../db.php';\ninclude 'generate-student-id.php'; // Include ang helper file\n\n// Check admin authentication\nif (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n    header(\"Location: ../../logregfor/admin-login.php\");\n    exit();\n}\n\n// Handle AJAX requests for enrollment actions\nif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {\n    $enrollmentId = $_POST['enrollment_id'] ?? 0;\n    $action = $_POST['action'];\n    $remarks = $_POST['remarks'] ?? '';\n    \n    $response = ['success' => false, 'message' => ''];\n    \n    try {\n        switch ($action) {\n            case 'approve':\n                // UPDATED: Get enrollment details first\n                $stmt = $conn->prepare(\"\n                    SELECT e.*, s.student_id as current_student_id \n                    FROM enrollments e \n                    JOIN students s ON e.student_id = s.student_id \n                    WHERE e.id = ?\n                \");\n                $stmt->bind_param(\"i\", $enrollmentId);\n                $stmt->execute();\n                $enrollment = $stmt->get_result()->fetch_assoc();\n                \n                if ($enrollment) {\n                    // Check if student already has new ID format\n                    $currentStudentId = $enrollment['current_student_id'];\n                    $needsNewId = !preg_match('/^TLGC-/', $currentStudentId);\n                    \n                    if ($needsNewId) {\n                        // Generate new student ID based on program\n                        $newStudentId = generateStudentId($conn, $enrollment['program']);\n                        \n                        // Update student ID in all related tables\n                        if (updateStudentId($conn, $currentStudentId, $newStudentId)) {\n                            $message = \"Enrollment approved and Student ID updated to: {$newStudentId}\";\n                        } else {\n                            throw new Exception(\"Failed to update Student ID\");\n                        }\n                    } else {\n                        $message = \"Enrollment approved successfully!\";\n                    }\n                    \n                    // Update enrollment status\n                    $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'approved', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n                    $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                    $stmt->execute();\n                    \n                    $response = ['success' => true, 'message' => $message];\n                } else {\n                    throw new Exception(\"Enrollment not found\");\n                }\n                break;\n                \n            case 'reject':\n                $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'rejected', processed_by = ?, date_processed = NOW(), rejection_reason = ? WHERE id = ?\");\n                $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                $stmt->execute();\n                $response = ['success' => true, 'message' => 'Enrollment rejected successfully!'];\n                break;\n                \n            case 'missing_documents':\n                $stmt = $conn->prepare(\"UPDATE enrollments SET status = 'missing_documents', processed_by = ?, date_processed = NOW(), remarks = ? WHERE id = ?\");\n                $stmt->bind_param(\"isi\", $_SESSION['admin_id'], $remarks, $enrollmentId);\n                $stmt->execute();\n                $response = ['success' => true, 'message' => 'Marked as missing documents!'];\n                break;\n        }\n    } catch (Exception $e) {\n        $response = ['success' => false, 'message' => 'Error: ' . $e->getMessage()];\n    }\n    \n    header('Content-Type: application/json');\n    echo json_encode($response);\n    exit();\n}\n\n// Get pending enrollments with student details\n$stmt = $conn->prepare(\"\n    SELECT \n        e.*,\n        CONCAT(s.first_name, ' ', s.last_name) as student_name,\n        s.email as student_email,\n        s.contact_number,\n        s.student_id as current_student_id\n    FROM enrollments e \n    LEFT JOIN students s ON e.student_id = s.student_id\n    WHERE e.status = 'pending'\n    ORDER BY e.date_submitted DESC\n\");\n$stmt->execute();\n$pendingEnrollments = $stmt->get_result()->fetch_all(MYSQLI_ASSOC);\n\n// Get statistics\n$stats = [];\n$statuses = ['pending', 'approved', 'rejected', 'missing_documents'];\nforeach ($statuses as $status) {\n    $stmt = $conn->prepare(\"SELECT COUNT(*) as count FROM enrollments WHERE status = ?\");\n    $stmt->bind_param(\"s\", $status);\n    $stmt->execute();\n    $stats[$status] = $stmt->get_result()->fetch_assoc()['count'];\n}\n?>\n\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <title>Pending Enrollments - TLGC Admin</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css\" rel=\"stylesheet\">\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n    <style>\n        body {\n            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);\n            font-family: 'Segoe UI', sans-serif;\n        }\n        .navbar {\n            background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);\n            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n        }\n        .school-logo {\n            width: 50px;\n            height: 50px;\n            object-fit: cover;\n            border-radius: 50%;\n            margin-right: 10px;\n            border: 2px solid #fff;\n        }\n        .stats-card {\n            border-radius: 15px;\n            border: none;\n            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);\n            transition: transform 0.3s ease;\n        }\n        .stats-card:hover {\n            transform: translateY(-5px);\n        }\n        .student-id-preview {\n            font-family: 'Courier New', monospace;\n            background: #f8f9fa;\n            padding: 5px 10px;\n            border-radius: 5px;\n            border: 1px solid #dee2e6;\n            font-size: 0.9em;\n        }\n        .id-will-change {\n            color: #28a745;\n            font-weight: bold;\n        }\n    </style>\n</head>\n<body>\n    <!-- Navigation -->\n    <nav class=\"navbar navbar-expand-lg navbar-dark py-3\">\n        <div class=\"container-fluid\">\n            <a class=\"navbar-brand d-flex align-items-center\" href=\"../admin-dashboard.php\">\n                <img src=\"../../picture/tlgc_pic.jpg\" alt=\"School Logo\" class=\"school-logo\">\n                TLGC Admin Panel\n            </a>\n            <div class=\"navbar-nav ms-auto\">\n                <a class=\"nav-link\" href=\"../admin-dashboard.php\">\n                    <i class=\"bi bi-arrow-left me-1\"></i>Back to Dashboard\n                </a>\n            </div>\n        </div>\n    </nav>\n\n    <div class=\"container-fluid py-4\">\n        <!-- Page Header -->\n        <div class=\"row mb-4\">\n            <div class=\"col-12\">\n                <h2 class=\"mb-1\">Pending Enrollments</h2>\n                <p class=\"text-muted\">Review and process student enrollment requests</p>\n            </div>\n        </div>\n\n        <!-- Statistics Cards -->\n        <div class=\"row mb-4\">\n            <div class=\"col-lg-3 col-md-6 mb-3\">\n                <div class=\"card stats-card bg-warning text-white\">\n                    <div class=\"card-body text-center\">\n                        <h3><?= $stats['pending'] ?></h3>\n                        <p class=\"mb-0\">Pending</p>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-lg-3 col-md-6 mb-3\">\n                <div class=\"card stats-card bg-success text-white\">\n                    <div class=\"card-body text-center\">\n                        <h3><?= $stats['approved'] ?></h3>\n                        <p class=\"mb-0\">Approved</p>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-lg-3 col-md-6 mb-3\">\n                <div class=\"card stats-card bg-danger text-white\">\n                    <div class=\"card-body text-center\">\n                        <h3><?= $stats['rejected'] ?></h3>\n                        <p class=\"mb-0\">Rejected</p>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-lg-3 col-md-6 mb-3\">\n                <div class=\"card stats-card bg-info text-white\">\n                    <div class=\"card-body text-center\">\n                        <h3><?= $stats['missing_documents'] ?></h3>\n                        <p class=\"mb-0\">Missing Documents</p>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <!-- Enrollments Table -->\n        <div class=\"row\">\n            <div class=\"col-12\">\n                <div class=\"card\">\n                    <div class=\"card-header\">\n                        <h5 class=\"mb-0\">Pending Enrollment Requests</h5>\n                    </div>\n                    <div class=\"card-body p-0\">\n                        <?php if (empty($pendingEnrollments)): ?>\n                            <div class=\"text-center py-5\">\n                                <i class=\"bi bi-inbox display-1 text-muted\"></i>\n                                <h4 class=\"text-muted mt-3\">No Pending Enrollments</h4>\n                                <p class=\"text-muted\">All enrollment requests have been processed.</p>\n                            </div>\n                        <?php else: ?>\n                            <div class=\"table-responsive\">\n                                <table class=\"table table-hover mb-0\">\n                                    <thead class=\"table-light\">\n                                        <tr>\n                                            <th>Student</th>\n                                            <th>Current ID</th>\n                                            <th>Program</th>\n                                            <th>Year & Section</th>\n                                            <th>Contact</th>\n                                            <th>Date Submitted</th>\n                                            <th>Actions</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                        <?php foreach ($pendingEnrollments as $enrollment): ?>\n                                        <?php \n                                            // Preview what the new student ID will be\n                                            $previewId = generateStudentId($conn, $enrollment['program']);\n                                            $needsNewId = !preg_match('/^TLGC-/', $enrollment['current_student_id']);\n                                        ?>\n                                        <tr>\n                                            <td>\n                                                <div>\n                                                    <strong><?= htmlspecialchars($enrollment['student_name'] ?: 'Student ID: ' . $enrollment['student_id']) ?></strong>\n                                                    <br>\n                                                    <small class=\"text-muted\">ID: <?= htmlspecialchars($enrollment['student_id']) ?></small>\n                                                </div>\n                                            </td>\n                                            <td>\n                                                <div class=\"student-id-preview\">\n                                                    <?= htmlspecialchars($enrollment['current_student_id']) ?>\n                                                </div>\n                                                <?php if ($needsNewId): ?>\n                                                    <small class=\"id-will-change\">\n                                                        <i class=\"bi bi-arrow-right\"></i> Will become: <strong><?= $previewId ?></strong>\n                                                    </small>\n                                                <?php else: ?>\n                                                    <small class=\"text-muted\">âœ“ Already has new format</small>\n                                                <?php endif; ?>\n                                            </td>\n                                            <td><?= htmlspecialchars($enrollment['program']) ?></td>\n                                            <td>\n                                                <?= htmlspecialchars($enrollment['year_level']) ?><br>\n                                                <small class=\"text-muted\">Section: <?= htmlspecialchars($enrollment['section']) ?></small>\n                                            </td>\n                                            <td>\n                                                <?= htmlspecialchars($enrollment['student_email'] ?: 'N/A') ?><br>\n                                                <small class=\"text-muted\"><?= htmlspecialchars($enrollment['contact_number'] ?: 'N/A') ?></small>\n                                            </td>\n                                            <td><?= date('M d, Y g:i A', strtotime($enrollment['date_submitted'])) ?></td>\n                                            <td>\n                                                <div class=\"btn-group-vertical btn-group-sm\">\n                                                    <button class=\"btn btn-success btn-sm\" onclick=\"processEnrollment(<?= $enrollment['id'] ?>, 'approve', '<?= htmlspecialchars($enrollment['student_name']) ?>')\">\n                                                        <i class=\"bi bi-check-circle me-1\"></i>Approve\n                                                        <?php if ($needsNewId): ?>\n                                                            <br><small>& Update ID</small>\n                                                        <?php endif; ?>\n                                                    </button>\n                                                    <button class=\"btn btn-warning btn-sm\" onclick=\"processEnrollment(<?= $enrollment['id'] ?>, 'missing_documents', '<?= htmlspecialchars($enrollment['student_name']) ?>')\">\n                                                        <i class=\"bi bi-exclamation-triangle me-1\"></i>Missing Docs\n                                                    </button>\n                                                    <button class=\"btn btn-danger btn-sm\" onclick=\"processEnrollment(<?= $enrollment['id'] ?>, 'reject', '<?= htmlspecialchars($enrollment['student_name']) ?>')\">\n                                                        <i class=\"bi bi-x-circle me-1\"></i>Reject\n                                                    </button>\n                                                </div>\n                                            </td>\n                                        </tr>\n                                        <?php endforeach; ?>\n                                    </tbody>\n                                </table>\n                            </div>\n                        <?php endif; ?>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Action Modal -->\n    <div class=\"modal fade\" id=\"actionModal\" tabindex=\"-1\">\n        <div class=\"modal-dialog\">\n            <div class=\"modal-content\">\n                <div class=\"modal-header\">\n                    <h5 class=\"modal-title\" id=\"modalTitle\">Confirm Action</h5>\n                    <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n                </div>\n                <div class=\"modal-body\">\n                    <p id=\"modalMessage\"></p>\n                    <div class=\"mb-3\">\n                        <label for=\"remarksInput\" class=\"form-label\">Remarks (Optional)</label>\n                        <textarea class=\"form-control\" id=\"remarksInput\" rows=\"3\" placeholder=\"Add any comments or reasons...\"></textarea>\n                    </div>\n                </div>\n                <div class=\"modal-footer\">\n                    <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancel</button>\n                    <button type=\"button\" class=\"btn btn-primary\" id=\"confirmBtn\">Confirm</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        let currentEnrollmentId = null;\n        let currentAction = null;\n\n        function processEnrollment(enrollmentId, action, studentName) {\n            currentEnrollmentId = enrollmentId;\n            currentAction = action;\n            \n            const modal = new bootstrap.Modal(document.getElementById('actionModal'));\n            const modalTitle = document.getElementById('modalTitle');\n            const modalMessage = document.getElementById('modalMessage');\n            const confirmBtn = document.getElementById('confirmBtn');\n            \n            // Set modal content based on action\n            switch(action) {\n                case 'approve':\n                    modalTitle.textContent = 'Approve Enrollment';\n                    modalMessage.textContent = `Are you sure you want to approve the enrollment for ${studentName}? This will also update their Student ID if needed.`;\n                    confirmBtn.className = 'btn btn-success';\n                    confirmBtn.textContent = 'Approve';\n                    break;\n                case 'reject':\n                    modalTitle.textContent = 'Reject Enrollment';\n                    modalMessage.textContent = `Are you sure you want to reject the enrollment for ${studentName}?`;\n                    confirmBtn.className = 'btn btn-danger';\n                    confirmBtn.textContent = 'Reject';\n                    break;\n                case 'missing_documents':\n                    modalTitle.textContent = 'Mark as Missing Documents';\n                    modalMessage.textContent = `Mark ${studentName}'s enrollment as missing documents?`;\n                    confirmBtn.className = 'btn btn-warning';\n                    confirmBtn.textContent = 'Mark as Missing';\n                    break;\n            }\n            \n            modal.show();\n        }\n\n        document.getElementById('confirmBtn').addEventListener('click', function() {\n            const remarks = document.getElementById('remarksInput').value;\n            \n            // Show loading state\n            this.disabled = true;\n            this.textContent = 'Processing...';\n            \n            // Send AJAX request - UPDATED: changed filename\n            fetch('process-enrollment-updated.php', {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/x-www-form-urlencoded',\n                },\n                body: new URLSearchParams({\n                    action: currentAction,\n                    enrollment_id: currentEnrollmentId,\n                    remarks: remarks\n                })\n            })\n            .then(response => response.json())\n            .then(data => {\n                if (data.success) {\n                    // Show success message\n                    alert(data.message);\n                    // Reload page to update the table\n                    location.reload();\n                } else {\n                    alert('Error: ' + data.message);\n                    // Reset button\n                    this.disabled = false;\n                    this.textContent = 'Confirm';\n                }\n            })\n            .catch(error => {\n                alert('Error: ' + error.message);\n                // Reset button\n                this.disabled = false;\n                this.textContent = 'Confirm';\n            });\n        });\n    </script>\n</body>\n</html>\n"
        }
    ]
}