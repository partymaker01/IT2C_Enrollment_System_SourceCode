{
    "sourceFile": "ADMIN/Enrollment_Management/assign-subjects-section.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1748457306934,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1748457306934,
            "name": "Commit-0",
            "content": "<?php\r\n// Database connection\r\n$host = 'localhost';\r\n$db   = 'enrollment_system';\r\n$user = 'root';        // your DB user\r\n$pass = '';            // your DB password\r\n$charset = 'utf8mb4';\r\n\r\n$dsn = \"mysql:host=$host;dbname=$db;charset=$charset\";\r\n$options = [\r\n    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,\r\n    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\r\n];\r\n\r\ntry {\r\n    $pdo = new PDO($dsn, $user, $pass, $options);\r\n} catch (\\PDOException $e) {\r\n    exit('Database connection failed: ' . $e->getMessage());\r\n}\r\n\r\n$message = '';\r\n\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    $studentId = trim($_POST['studentId'] ?? '');\r\n    $studentName = trim($_POST['studentName'] ?? '');\r\n    $program = trim($_POST['program'] ?? '');\r\n    $yearLevel = trim($_POST['yearLevel'] ?? '');\r\n    $section = trim($_POST['section'] ?? '');\r\n    $subjects = $_POST['subjects'] ?? [];\r\n\r\n    if ($studentId && $studentName && $program && $yearLevel && $section && count($subjects) > 0) {\r\n        try {\r\n            // Start transaction\r\n            $pdo->beginTransaction();\r\n\r\n            // Insert or update student (if student_id exists, update info)\r\n            $stmt = $pdo->prepare(\"SELECT id FROM students WHERE student_id = ?\");\r\n            $stmt->execute([$studentId]);\r\n            $existingStudent = $stmt->fetch();\r\n\r\n            if ($existingStudent) {\r\n                $studentDbId = $existingStudent['id'];\r\n                // Update student info\r\n                $stmt = $pdo->prepare(\"UPDATE students SET student_name=?, program=?, year_level=?, section=? WHERE id=?\");\r\n                $stmt->execute([$studentName, $program, $yearLevel, $section, $studentDbId]);\r\n\r\n                // Clear existing assigned subjects first\r\n                $stmt = $pdo->prepare(\"DELETE FROM student_subjects WHERE student_id=?\");\r\n                $stmt->execute([$studentDbId]);\r\n            } else {\r\n                // Insert new student\r\n                $stmt = $pdo->prepare(\"INSERT INTO students (student_id, student_name, program, year_level, section) VALUES (?, ?, ?, ?, ?)\");\r\n                $stmt->execute([$studentId, $studentName, $program, $yearLevel, $section]);\r\n                $studentDbId = $pdo->lastInsertId();\r\n            }\r\n\r\n            // Assign subjects\r\n            $subjectStmt = $pdo->prepare(\"SELECT id FROM subjects WHERE subject_name = ?\");\r\n            $insertAssign = $pdo->prepare(\"INSERT INTO student_subjects (student_id, subject_id) VALUES (?, ?)\");\r\n\r\n            foreach ($subjects as $subjectName) {\r\n                $subjectStmt->execute([$subjectName]);\r\n                $subject = $subjectStmt->fetch();\r\n                if ($subject) {\r\n                    $insertAssign->execute([$studentDbId, $subject['id']]);\r\n                }\r\n            }\r\n\r\n            $pdo->commit();\r\n\r\n            $message = \"<div class='alert alert-success mt-4'>\r\n                Assigned <strong>\" . htmlspecialchars($studentName) . \"</strong> (ID: \" . htmlspecialchars($studentId) . \") to <strong>\" . htmlspecialchars($program) . \"</strong>, <strong>\" . htmlspecialchars($yearLevel) . \"</strong>, Section <strong>\" . htmlspecialchars($section) . \"</strong>.<br>\r\n                Subjects: <em>\" . implode(', ', array_map('htmlspecialchars', $subjects)) . \"</em>\r\n                </div>\";\r\n        } catch (Exception $e) {\r\n            $pdo->rollBack();\r\n            $message = \"<div class='alert alert-danger mt-4'>Error assigning subjects: \" . $e->getMessage() . \"</div>\";\r\n        }\r\n    } else {\r\n        $message = \"<div class='alert alert-danger mt-4'>Please fill in all required fields and select at least one subject.</div>\";\r\n    }\r\n}\r\n\r\n// Fetch all subjects for the dropdown\r\n$subjectsList = $pdo->query(\"SELECT subject_name FROM subjects ORDER BY subject_name ASC\")->fetchAll(PDO::FETCH_COLUMN);\r\n\r\n?>\r\n\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\" />\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n    <title>Assign Sections & Subjects</title>\r\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\" />\r\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\r\n    <style>\r\n        body { background-color: #f1f8e9; font-family: 'Segoe UI', sans-serif; }\r\n        .navbar { background-color: #2e7d32; }\r\n        .navbar-brand, .nav-link { color: #fff !important; font-weight: 600; letter-spacing: 0.05em; }\r\n        .nav-link:hover { color: #c8e6c9 !important; }\r\n        .school-logo { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; margin-right: 10px; border: 2px solid #fff; }\r\n        .card { border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); padding: 2rem; }\r\n        h2 { color: #2e7d32; font-weight: 700; }\r\n        .divider { height: 1px; background: #c5e1a5; margin: 1.5rem 0; }\r\n        .form-floating label { font-size: 0.9rem; }\r\n        select[multiple] { height: 150px; }\r\n        @media (max-width: 575.98px) { .card { padding: 1rem; } }\r\n    </style>\r\n    <link rel=\"icon\" href=\"favicon.ico\" type=\"image/x-icon\">\r\n</head>\r\n<body>\r\n<nav class=\"navbar navbar-expand-lg navbar-dark bg-success py-3\">\r\n    <div class=\"container-fluid\">\r\n        <a class=\"navbar-brand d-flex align-items-center\" href=\"#\">\r\n            <img src=\"/IT2C_Enrollment_System_SourceCode/picture/tlgc_pic.jpg\" alt=\"School Logo\" class=\"school-logo\">\r\n            Admin Panel\r\n        </a>\r\n        <button class=\"navbar-toggler\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#navbarNav\" \r\n            aria-controls=\"navbarNav\" aria-expanded=\"false\" aria-label=\"Toggle navigation\">\r\n            <span class=\"navbar-toggler-icon\"></span>\r\n        </button>\r\n        <div class=\"collapse navbar-collapse\" id=\"navbarNav\">\r\n            <ul class=\"navbar-nav ms-auto\">\r\n                <li class=\"nav-item\">\r\n                    <a class=\"nav-link\" href=\"/IT2C_Enrollment_System_SourceCode/ADMIN/admin-dashboard.php\">\r\n                        <i class=\"bi bi-arrow-left\"></i> Back to Dashboard\r\n                    </a>\r\n                </li>\r\n            </ul>\r\n        </div>\r\n    </div>\r\n</nav>\r\n\r\n<div class=\"container py-5\">\r\n    <h2 class=\"mb-4 text-center\">Assign Sections & Subjects</h2>\r\n\r\n    <div class=\"card mx-auto\" style=\"max-width: 900px;\">\r\n        <form method=\"POST\" action=\"\">\r\n            <div class=\"row g-3\">\r\n                <div class=\"col-md-6\">\r\n                    <div class=\"form-floating\">\r\n                        <input type=\"text\" class=\"form-control\" id=\"studentId\" name=\"studentId\" placeholder=\"Student ID\" value=\"<?= htmlspecialchars($_POST['studentId'] ?? '') ?>\" required>\r\n                        <label for=\"studentId\">Student ID</label>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-6\">\r\n                    <div class=\"form-floating\">\r\n                        <input type=\"text\" class=\"form-control\" id=\"studentName\" name=\"studentName\" placeholder=\"Student Name\" value=\"<?= htmlspecialchars($_POST['studentName'] ?? '') ?>\" required>\r\n                        <label for=\"studentName\">Student Name</label>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"divider\"></div>\r\n\r\n            <div class=\"row g-3\">\r\n                <div class=\"col-md-4\">\r\n                    <div class=\"form-floating\">\r\n                        <select class=\"form-select\" id=\"program\" name=\"program\" required>\r\n                            <option value=\"\" disabled <?= empty($_POST['program']) ? 'selected' : '' ?>>Select</option>\r\n                            <?php \r\n                            $programs = ['IT', 'HRMT', 'ECT', 'HST'];\r\n                            foreach ($programs as $prog): ?>\r\n                                <option value=\"<?= $prog ?>\" <?= ($_POST['program'] ?? '') === $prog ? 'selected' : '' ?>><?= $prog ?></option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                        <label for=\"program\">Program</label>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-4\">\r\n                    <div class=\"form-floating\">\r\n                        <select class=\"form-select\" id=\"yearLevel\" name=\"yearLevel\" required>\r\n                            <option value=\"\" disabled <?= empty($_POST['yearLevel']) ? 'selected' : '' ?>>Select</option>\r\n                            <?php \r\n                            $years = ['1st Year', '2nd Year', '3rd Year'];\r\n                            foreach ($years as $yr): ?>\r\n                                <option value=\"<?= $yr ?>\" <?= ($_POST['yearLevel'] ?? '') === $yr ? 'selected' : '' ?>><?= $yr ?></option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                        <label for=\"yearLevel\">Year Level</label>\r\n                    </div>\r\n                </div>\r\n                <div class=\"col-md-4\">\r\n                    <div class=\"form-floating\">\r\n                        <select class=\"form-select\" id=\"section\" name=\"section\" required>\r\n                            <option value=\"\" disabled <?= empty($_POST['section']) ? 'selected' : '' ?>>Select</option>\r\n                            <?php foreach (range('A', 'H') as $sec): ?>\r\n                                <option value=\"<?= $sec ?>\" <?= ($_POST['section'] ?? '') === $sec ? 'selected' : '' ?>><?= $sec ?></option>\r\n                            <?php endforeach; ?>\r\n                        </select>\r\n                        <label for=\"section\">Section</label>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"divider\"></div>\r\n\r\n            <div class=\"mb-3\">\r\n                <label for=\"subjects\" class=\"form-label fw-bold\">Assign Subjects (Manual)</label>\r\n                <select multiple class=\"form-select\" id=\"subjects\" name=\"subjects[]\" required>\r\n                    <?php\r\n                    foreach ($subjectsList as $subject) {\r\n                        $selected = (isset($_POST['subjects']) && in_array($subject, $_POST['subjects'])) ? 'selected' : '';\r\n                        echo \"<option value=\\\"\" . htmlspecialchars($subject) . \"\\\" $selected>\" . htmlspecialchars($subject) . \"</option>\";\r\n                    }\r\n                    ?>\r\n                </select>\r\n                <small class=\"text-muted\">Hold Ctrl (or Cmd) to select multiple subjects.</small>\r\n            </div>\r\n\r\n            <div class=\"d-flex justify-content-end gap-2\">\r\n                <button type=\"reset\" class=\"btn btn-outline-secondary\">Clear</button>\r\n                <button type=\"submit\" class=\"btn btn-success\">Assign</button>\r\n            </div>\r\n        </form>\r\n\r\n        <?= $message ?>\r\n    </div>\r\n</div>\r\n\r\n</body>\r\n</html>\r\n"
        }
    ]
}