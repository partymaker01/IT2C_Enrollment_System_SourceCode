{
    "sourceFile": "ADMIN/Student_Management/view-all-students.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1749400847695,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1749400847695,
            "name": "Commit-0",
            "content": "<?php\nsession_start();\nrequire_once '../../db.php';\n\n// Check if admin is logged in\nif (!isset($_SESSION['admin_id'])) {\n    header(\"Location: ../../logregfor/admin-login.php\");\n    exit();\n}\n\n// Handle delete action\nif (isset($_GET['delete_id'])) {\n    $student_id = $_GET['delete_id'];\n    \n    // Start transaction\n    $conn->begin_transaction();\n    \n    try {\n        // Delete related records first\n        $stmt1 = $conn->prepare(\"DELETE FROM enrollment_subjects WHERE enrollment_id IN (SELECT id FROM enrollments WHERE student_id = ?)\");\n        $stmt1->bind_param(\"s\", $student_id);\n        $stmt1->execute();\n        \n        $stmt2 = $conn->prepare(\"DELETE FROM enrollments WHERE student_id = ?\");\n        $stmt2->bind_param(\"s\", $student_id);\n        $stmt2->execute();\n        \n        $stmt3 = $conn->prepare(\"DELETE FROM students WHERE student_id = ?\");\n        $stmt3->bind_param(\"s\", $student_id);\n        $stmt3->execute();\n        \n        $conn->commit();\n        $message = \"Student deleted successfully!\";\n        $message_type = \"success\";\n        \n    } catch (Exception $e) {\n        $conn->rollback();\n        $message = \"Error deleting student: \" . $e->getMessage();\n        $message_type = \"danger\";\n    }\n}\n\n// Initialize search and filter parameters\n$search = isset($_GET['search']) ? trim($_GET['search']) : '';\n$program_filter = isset($_GET['program']) ? $_GET['program'] : '';\n$status_filter = isset($_GET['status']) ? $_GET['status'] : '';\n$year_filter = isset($_GET['year']) ? $_GET['year'] : '';\n\n// Build query with filters\n$sql = \"SELECT s.*, DATE_FORMAT(s.date_registered, '%M %d, %Y') as formatted_date \n        FROM students s WHERE 1=1\";\n\n$params = [];\n$types = \"\";\n\nif (!empty($search)) {\n    $sql .= \" AND (s.first_name LIKE ? OR s.middle_name LIKE ? OR s.last_name LIKE ? OR s.student_id LIKE ?)\";\n    $search_param = \"%$search%\";\n    $params = array_merge($params, [$search_param, $search_param, $search_param, $search_param]);\n    $types .= \"ssss\";\n}\n\nif (!empty($program_filter)) {\n    $sql .= \" AND s.program = ?\";\n    $params[] = $program_filter;\n    $types .= \"s\";\n}\n\nif (!empty($status_filter)) {\n    $sql .= \" AND s.status = ?\";\n    $params[] = $status_filter;\n    $types .= \"s\";\n}\n\nif (!empty($year_filter)) {\n    $sql .= \" AND s.year_level = ?\";\n    $params[] = $year_filter;\n    $types .= \"s\";\n}\n\n$sql .= \" ORDER BY s.student_id ASC\";\n\n$stmt = $conn->prepare($sql);\nif (!empty($params)) {\n    $stmt->bind_param($types, ...$params);\n}\n$stmt->execute();\n$result = $stmt->get_result();\n$students = $result->fetch_all(MYSQLI_ASSOC);\n$stmt->close();\n\n// Get filter options\n$programs_query = \"SELECT DISTINCT program FROM students ORDER BY program\";\n$programs_result = $conn->query($programs_query);\n\n$years_query = \"SELECT DISTINCT year_level FROM students ORDER BY year_level\";\n$years_result = $conn->query($years_query);\n?>\n\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>View All Students - Admin Panel</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css\" rel=\"stylesheet\">\n    <link rel=\"icon\" href=\"../../favicon.ico\" type=\"image/x-icon\">\n    <style>\n        body {\n            background-color: #e6f2e6;\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n        }\n        .navbar {\n            background: linear-gradient(135deg, #2e7d32, #388e3c);\n            box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n        }\n        .navbar-brand, .nav-link {\n            color: #fff !important;\n            font-weight: 600;\n            letter-spacing: 0.05em;\n        }\n        .nav-link:hover {\n            color: #c8e6c9 !important;\n        }\n        .school-logo {\n            width: 50px;\n            height: 50px;\n            object-fit: cover;\n            border-radius: 50%;\n            margin-right: 10px;\n            border: 2px solid #fff;\n        }\n        .filter-section {\n            background: white;\n            border-radius: 10px;\n            padding: 20px;\n            margin-bottom: 30px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        }\n        .table-container {\n            background: white;\n            border-radius: 10px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            overflow: hidden;\n        }\n        .table thead {\n            background: linear-gradient(135deg, #2e7d32, #388e3c);\n            color: white;\n        }\n        .table tbody tr:hover {\n            background-color: #e8f5e8;\n            transition: background-color 0.3s ease;\n        }\n        .btn-action {\n            margin: 2px;\n            min-width: 70px;\n        }\n        .status-badge {\n            font-size: 0.85rem;\n        }\n        .stats-row {\n            margin-bottom: 30px;\n        }\n        .stats-card {\n            background: linear-gradient(135deg, #fff, #f8f9fa);\n            border-left: 4px solid #28a745;\n            transition: transform 0.3s ease;\n        }\n        .stats-card:hover {\n            transform: translateY(-2px);\n        }\n        @media (max-width: 768px) {\n            .btn-action {\n                width: 100%;\n                margin-bottom: 5px;\n            }\n            .filter-section .row > div {\n                margin-bottom: 15px;\n            }\n        }\n    </style>\n</head>\n<body>\n    <nav class=\"navbar navbar-expand-lg navbar-dark py-3\">\n        <div class=\"container-fluid\">\n            <a class=\"navbar-brand d-flex align-items-center\" href=\"#\">\n                <img src=\"../../picture/tlgc_pic.jpg\" alt=\"School Logo\" class=\"school-logo\">\n                Admin Panel\n            </a>\n            <button class=\"navbar-toggler\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#navbarNav\">\n                <span class=\"navbar-toggler-icon\"></span>\n            </button>\n            <div class=\"collapse navbar-collapse\" id=\"navbarNav\">\n                <ul class=\"navbar-nav ms-auto\">\n                    <li class=\"nav-item\">\n                        <a class=\"nav-link\" href=\"../admin-dashboard.php\">\n                            <i class=\"bi bi-arrow-left\"></i> Back to Dashboard\n                        </a>\n                    </li>\n                </ul>\n            </div>\n        </div>\n    </nav>\n\n    <div class=\"container my-5\">\n        <?php if (isset($message)): ?>\n            <div class=\"alert alert-<?= $message_type ?> alert-dismissible fade show\" role=\"alert\">\n                <i class=\"bi bi-<?= $message_type == 'success' ? 'check-circle' : 'exclamation-triangle' ?>\"></i>\n                <?= $message ?>\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\n            </div>\n        <?php endif; ?>\n\n        <div class=\"row mb-4\">\n            <div class=\"col-md-8\">\n                <h2 class=\"text-success fw-bold\">\n                    <i class=\"bi bi-people\"></i> View All Students\n                </h2>\n                <p class=\"text-muted\">Manage and view student information</p>\n            </div>\n            <div class=\"col-md-4 text-end\">\n                <a href=\"manage-students-account.php\" class=\"btn btn-success\">\n                    <i class=\"bi bi-plus-circle\"></i> Add New Student\n                </a>\n            </div>\n        </div>\n\n        <!-- Statistics Cards -->\n        <div class=\"row stats-row\">\n            <div class=\"col-md-3\">\n                <div class=\"card stats-card\">\n                    <div class=\"card-body text-center\">\n                        <h4 class=\"text-success\"><?= count($students) ?></h4>\n                        <small class=\"text-muted\">Total Students</small>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-md-3\">\n                <div class=\"card stats-card\">\n                    <div class=\"card-body text-center\">\n                        <h4 class=\"text-primary\"><?= count(array_filter($students, fn($s) => $s['status'] == 'active')) ?></h4>\n                        <small class=\"text-muted\">Active Students</small>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-md-3\">\n                <div class=\"card stats-card\">\n                    <div class=\"card-body text-center\">\n                        <h4 class=\"text-warning\"><?= count(array_filter($students, fn($s) => $s['status'] == 'pending')) ?></h4>\n                        <small class=\"text-muted\">Pending Approval</small>\n                    </div>\n                </div>\n            </div>\n            <div class=\"col-md-3\">\n                <div class=\"card stats-card\">\n                    <div class=\"card-body text-center\">\n                        <h4 class=\"text-info\"><?= count(array_unique(array_column($students, 'program'))) ?></h4>\n                        <small class=\"text-muted\">Programs</small>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <!-- Filters Section -->\n        <div class=\"filter-section\">\n            <form method=\"GET\" class=\"row g-3\">\n                <div class=\"col-md-3\">\n                    <label class=\"form-label fw-semibold\">Search Student</label>\n                    <input type=\"text\" class=\"form-control\" name=\"search\" value=\"<?= htmlspecialchars($search) ?>\" \n                           placeholder=\"Name or Student ID\">\n                </div>\n                <div class=\"col-md-2\">\n                    <label class=\"form-label fw-semibold\">Program</label>\n                    <select class=\"form-select\" name=\"program\">\n                        <option value=\"\">All Programs</option>\n                        <?php while ($program = $programs_result->fetch_assoc()): ?>\n                            <option value=\"<?= $program['program'] ?>\" <?= $program_filter == $program['program'] ? 'selected' : '' ?>>\n                                <?= $program['program'] ?>\n                            </option>\n                        <?php endwhile; ?>\n                    </select>\n                </div>\n                <div class=\"col-md-2\">\n                    <label class=\"form-label fw-semibold\">Year Level</label>\n                    <select class=\"form-select\" name=\"year\">\n                        <option value=\"\">All Years</option>\n                        <?php while ($year = $years_result->fetch_assoc()): ?>\n                            <option value=\"<?= $year['year_level'] ?>\" <?= $year_filter == $year['year_level'] ? 'selected' : '' ?>>\n                                <?= $year['year_level'] ?>\n                            </option>\n                        <?php endwhile; ?>\n                    </select>\n                </div>\n                <div class=\"col-md-2\">\n                    <label class=\"form-label fw-semibold\">Status</label>\n                    <select class=\"form-select\" name=\"status\">\n                        <option value=\"\">All Status</option>\n                        <option value=\"active\" <?= $status_filter == 'active' ? 'selected' : '' ?>>Active</option>\n                        <option value=\"pending\" <?= $status_filter == 'pending' ? 'selected' : '' ?>>Pending</option>\n                        <option value=\"inactive\" <?= $status_filter == 'inactive' ? 'selected' : '' ?>>Inactive</option>\n                    </select>\n                </div>\n                <div class=\"col-md-3 d-flex align-items-end\">\n                    <button type=\"submit\" class=\"btn btn-success me-2\">\n                        <i class=\"bi bi-search\"></i> Filter\n                    </button>\n                    <a href=\"?\" class=\"btn btn-outline-secondary me-2\">\n                        <i class=\"bi bi-arrow-clockwise\"></i> Reset\n                    </a>\n                    <button type=\"button\" class=\"btn btn-info\" onclick=\"exportToCSV()\">\n                        <i class=\"bi bi-download\"></i> Export\n                    </button>\n                </div>\n            </form>\n        </div>\n\n        <!-- Students Table -->\n        <div class=\"table-container\">\n            <div class=\"table-responsive\">\n                <table class=\"table table-hover align-middle mb-0\" id=\"studentsTable\">\n                    <thead>\n                        <tr>\n                            <th>Student ID</th>\n                            <th>Full Name</th>\n                            <th>Program</th>\n                            <th>Year Level</th>\n                            <th>Contact</th>\n                            <th>Status</th>\n                            <th>Date Registered</th>\n                            <th class=\"text-center\">Actions</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        <?php if (!empty($students)): ?>\n                            <?php foreach ($students as $student): ?>\n                                <tr>\n                                    <td class=\"fw-semibold\"><?= htmlspecialchars($student['student_id']) ?></td>\n                                    <td><?= htmlspecialchars($student['first_name'] . ' ' . $student['middle_name'] . ' ' . $student['last_name']) ?></td>\n                                    <td>\n                                        <span class=\"badge bg-primary\"><?= htmlspecialchars($student['program']) ?></span>\n                                    </td>\n                                    <td><?= htmlspecialchars($student['year_level']) ?></td>\n                                    <td>\n                                        <small>\n                                            <i class=\"bi bi-envelope\"></i> <?= htmlspecialchars($student['email']) ?><br>\n                                            <i class=\"bi bi-phone\"></i> <?= htmlspecialchars($student['contact_number']) ?>\n                                        </small>\n                                    </td>\n                                    <td>\n                                        <span class=\"badge status-badge <?= \n                                            $student['status'] == 'active' ? 'bg-success' : \n                                            ($student['status'] == 'pending' ? 'bg-warning' : 'bg-secondary') \n                                        ?>\">\n                                            <?= ucfirst($student['status']) ?>\n                                        </span>\n                                    </td>\n                                    <td><?= $student['formatted_date'] ?></td>\n                                    <td class=\"text-center\">\n                                        <div class=\"btn-group-vertical btn-group-sm\" role=\"group\">\n                                            <a href=\"view-student-details.php?id=<?= urlencode($student['student_id']) ?>\" \n                                               class=\"btn btn-primary btn-action\" title=\"View Details\">\n                                                <i class=\"bi bi-eye\"></i> View\n                                            </a>\n                                            <a href=\"edit-student.php?id=<?= urlencode($student['student_id']) ?>\" \n                                               class=\"btn btn-warning btn-action\" title=\"Edit Student\">\n                                                <i class=\"bi bi-pencil\"></i> Edit\n                                            </a>\n                                            <button class=\"btn btn-danger btn-action\" title=\"Delete Student\" \n                                                    onclick=\"confirmDelete('<?= htmlspecialchars($student['student_id']) ?>', '<?= htmlspecialchars($student['first_name'] . ' ' . $student['last_name']) ?>')\">\n                                                <i class=\"bi bi-trash\"></i> Delete\n                                            </button>\n                                        </div>\n                                    </td>\n                                </tr>\n                            <?php endforeach; ?>\n                        <?php else: ?>\n                            <tr>\n                                <td colspan=\"8\" class=\"text-center py-4\">\n                                    <i class=\"bi bi-people display-4 text-muted\"></i>\n                                    <h5 class=\"text-muted mt-2\">No students found</h5>\n                                    <p class=\"text-muted\">Try adjusting your search criteria.</p>\n                                </td>\n                            </tr>\n                        <?php endif; ?>\n                    </tbody>\n                </table>\n            </div>\n        </div>\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n    <script>\n        function confirmDelete(studentId, studentName) {\n            if (confirm(`Are you sure you want to delete ${studentName}? This action cannot be undone.`)) {\n                window.location.href = `?delete_id=${encodeURIComponent(studentId)}`;\n            }\n        }\n\n        function exportToCSV() {\n            let csvContent = \"Student ID,Full Name,Program,Year Level,Email,Contact Number,Status,Date Registered\\n\";\n            \n            const rows = document.querySelectorAll('#studentsTable tbody tr');\n            rows.forEach(row => {\n                const cells = row.querySelectorAll('td');\n                if (cells.length >= 7) {\n                    const studentId = cells[0].textContent.trim();\n                    const fullName = cells[1].textContent.trim();\n                    const program = cells[2].textContent.trim();\n                    const yearLevel = cells[3].textContent.trim();\n                    const contact = cells[4].textContent.trim().replace(/\\n/g, ' ');\n                    const status = cells[5].textContent.trim();\n                    const dateRegistered = cells[6].textContent.trim();\n                    \n                    csvContent += `\"${studentId}\",\"${fullName}\",\"${program}\",\"${yearLevel}\",\"${contact}\",\"${status}\",\"${dateRegistered}\"\\n`;\n                }\n            });\n            \n            const blob = new Blob([csvContent], { type: 'text/csv' });\n            const url = window.URL.createObjectURL(blob);\n            const a = document.createElement('a');\n            a.href = url;\n            a.download = 'students_' + new Date().toISOString().split('T')[0] + '.csv';\n            document.body.appendChild(a);\n            a.click();\n            document.body.removeChild(a);\n            window.URL.revokeObjectURL(url);\n        }\n    </script>\n</body>\n</html>\n\n<?php $conn->close(); ?>\n"
        }
    ]
}