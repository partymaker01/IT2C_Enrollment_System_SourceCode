{
    "sourceFile": "ADMIN/helpdeskAdminProfileSettings/settings.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1749402274305,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1749402274305,
            "name": "Commit-0",
            "content": "<?php\nsession_start();\n\n// Check if logged in\nif (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {\n    header(\"Location: ../../logregfor/admin-login.php\");\n    exit();\n}\n\n// Database connection\ninclude '../../db.php';\n\n// Fetch admin settings (assuming id=1 for the admin)\n$admin_id = $_SESSION['admin_id'];\n$sql = \"SELECT * FROM admin_settings WHERE id = ? LIMIT 1\";\n$stmt = $pdo->prepare($sql);\n$stmt->execute([$admin_id]);\n$settings = $stmt->fetch();\n\nif (!$settings) {\n    die(\"Admin settings not found.\");\n}\n\n$success = \"\";\n$error = \"\";\n\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\n    $name = trim($_POST['adminName']);\n    $email = filter_var($_POST['adminEmail'], FILTER_SANITIZE_EMAIL);\n    $email_notify = isset($_POST['emailNotify']) ? 1 : 0;\n    $sms_notify = isset($_POST['smsNotify']) ? 1 : 0;\n    $maintenance_mode = isset($_POST['maintenanceMode']) ? 1 : 0;\n    $auto_backup = isset($_POST['autoBackup']) ? 1 : 0;\n\n    // Password change handling\n    if (!empty($_POST['currentPassword']) && !empty($_POST['newPassword']) && !empty($_POST['confirmPassword'])) {\n        if (password_verify($_POST['currentPassword'], $settings['password'])) {\n            if ($_POST['newPassword'] === $_POST['confirmPassword']) {\n                $newPasswordHash = password_hash($_POST['newPassword'], PASSWORD_DEFAULT);\n            } else {\n                $error = \"New password and confirmation do not match.\";\n            }\n        } else {\n            $error = \"Current password is incorrect.\";\n        }\n    }\n\n    if (empty($error)) {\n        // Build update query\n        $update_sql = \"UPDATE admin_settings SET \n            name = :name,\n            email = :email,\n            email_notify = :email_notify,\n            sms_notify = :sms_notify,\n            maintenance_mode = :maintenance_mode,\n            auto_backup = :auto_backup\";\n\n        $params = [\n            ':name' => $name,\n            ':email' => $email,\n            ':email_notify' => $email_notify,\n            ':sms_notify' => $sms_notify,\n            ':maintenance_mode' => $maintenance_mode,\n            ':auto_backup' => $auto_backup\n        ];\n\n        if (isset($newPasswordHash)) {\n            $update_sql .= \", password = :password\";\n            $params[':password'] = $newPasswordHash;\n            $success = \"Password and settings updated successfully!\";\n        } else {\n            $success = \"Settings updated successfully!\";\n        }\n\n        $update_sql .= \" WHERE id = :id\";\n        $params[':id'] = $admin_id;\n\n        $stmt = $pdo->prepare($update_sql);\n        if ($stmt->execute($params)) {\n            // Update session name\n            $_SESSION['admin_name'] = $name;\n            \n            // Refresh $settings with updated data\n            $stmt = $pdo->prepare(\"SELECT * FROM admin_settings WHERE id = ? LIMIT 1\");\n            $stmt->execute([$admin_id]);\n            $settings = $stmt->fetch();\n        } else {\n            $error = \"Error updating settings.\";\n        }\n    }\n}\n?>\n\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Admin Settings</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css\" rel=\"stylesheet\">\n    <link rel=\"icon\" href=\"../../picture/tlgc_pic.jpg\" type=\"image/x-icon\">\n    <style>\n        :root {\n            --primary-green: #2e7d32;\n            --light-green: #e8f5e9;\n            --accent-green: #43a047;\n            --hover-green: #c8e6c9;\n            --dark-green: #1b5e20;\n        }\n        \n        body {\n            background: linear-gradient(to right, var(--light-green), #f1f8e9);\n            min-height: 100vh;\n            font-family: 'Segoe UI', sans-serif;\n        }\n        \n        .navbar {\n            background-color: var(--primary-green);\n        }\n        \n        .navbar-brand, .nav-link {\n            color: #fff !important;\n            font-weight: 600;\n        }\n        \n        .navbar-brand img {\n            height: 50px;\n            width: 50px;\n            border-radius: 50%;\n            margin-right: 10px;\n            border: 2px solid white;\n        }\n        \n        .card {\n            background: #fff;\n            padding: 2rem;\n            border-radius: 1rem;\n            max-width: 900px;\n            margin: auto;\n            box-shadow: 0 0 15px rgba(0,0,0,0.1);\n        }\n        \n        h2 {\n            color: var(--primary-green);\n        }\n        \n        section h5 {\n            border-left: 4px solid var(--primary-green);\n            padding-left: 10px;\n            margin-bottom: 1rem;\n            color: var(--accent-green);\n        }\n        \n        .form-check-label {\n            font-weight: 500;\n        }\n        \n        .btn-primary {\n            background-color: var(--primary-green);\n            border-color: var(--primary-green);\n        }\n        \n        .btn-primary:hover {\n            background-color: var(--dark-green);\n        }\n        \n        .alert {\n            max-width: 800px;\n            margin: 20px auto;\n        }\n    </style>\n</head>\n<body>\n    <nav class=\"navbar navbar-expand-lg navbar-dark py-3\">\n        <div class=\"container-fluid\">\n            <a class=\"navbar-brand d-flex align-items-center\" href=\"../admin-dashboard.php\">\n                <img src=\"../../picture/tlgc_pic.jpg\" alt=\"School Logo\" class=\"school-logo\">\n                Admin Panel\n            </a>\n            <button class=\"navbar-toggler\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#navbarNav\">\n                <span class=\"navbar-toggler-icon\"></span>\n            </button>\n            <div class=\"collapse navbar-collapse\" id=\"navbarNav\">\n                <ul class=\"navbar-nav ms-auto\">\n                    <li class=\"nav-item\">\n                        <a class=\"nav-link\" href=\"../admin-dashboard.php\">\n                            <i class=\"bi bi-arrow-left me-1\"></i> Back to Dashboard\n                        </a>\n                    </li>\n                </ul>\n            </div>\n        </div>\n    </nav>\n\n    <main class=\"py-4\">\n        <div class=\"card\">\n            <h2 class=\"text-center mb-4\"><i class=\"bi bi-gear-fill me-2\"></i>Admin Settings</h2>\n\n            <?php if ($success): ?>\n                <div class=\"alert alert-success d-flex align-items-center\">\n                    <i class=\"bi bi-check-circle-fill me-2\"></i>\n                    <div><?= htmlspecialchars($success) ?></div>\n                </div>\n            <?php elseif ($error): ?>\n                <div class=\"alert alert-danger d-flex align-items-center\">\n                    <i class=\"bi bi-exclamation-triangle-fill me-2\"></i>\n                    <div><?= htmlspecialchars($error) ?></div>\n                </div>\n            <?php endif; ?>\n\n            <form method=\"post\" novalidate>\n                <section class=\"mb-4\">\n                    <h5><i class=\"bi bi-person-circle me-2\"></i>Profile Information</h5>\n                    <div class=\"mb-3\">\n                        <label for=\"adminName\" class=\"form-label\">Full Name</label>\n                        <input type=\"text\" class=\"form-control\" id=\"adminName\" name=\"adminName\" value=\"<?= htmlspecialchars($settings['name']) ?>\" required>\n                    </div>\n                    <div class=\"mb-3\">\n                        <label for=\"adminEmail\" class=\"form-label\">Email Address</label>\n                        <input type=\"email\" class=\"form-control\" id=\"adminEmail\" name=\"adminEmail\" value=\"<?= htmlspecialchars($settings['email']) ?>\" required>\n                    </div>\n                </section>\n\n                <section class=\"mb-4\">\n                    <h5><i class=\"bi bi-key-fill me-2\"></i>Change Password</h5>\n                    <div class=\"row g-3\">\n                        <div class=\"col-md-4\">\n                            <label for=\"currentPassword\" class=\"form-label\">Current Password</label>\n                            <input type=\"password\" class=\"form-control\" id=\"currentPassword\" name=\"currentPassword\">\n                        </div>\n                        <div class=\"col-md-4\">\n                            <label for=\"newPassword\" class=\"form-label\">New Password</label>\n                            <input type=\"password\" class=\"form-control\" id=\"newPassword\" name=\"newPassword\">\n                        </div>\n                        <div class=\"col-md-4\">\n                            <label for=\"confirmPassword\" class=\"form-label\">Confirm New Password</label>\n                            <input type=\"password\" class=\"form-control\" id=\"confirmPassword\" name=\"confirmPassword\">\n                        </div>\n                    </div>\n                </section>\n\n                <section class=\"mb-4\">\n                    <h5><i class=\"bi bi-bell-fill me-2\"></i>Notification Preferences</h5>\n                    <div class=\"form-check\">\n                        <input class=\"form-check-input\" type=\"checkbox\" id=\"emailNotify\" name=\"emailNotify\" <?= $settings['email_notify'] ? 'checked' : '' ?> />\n                        <label class=\"form-check-label\" for=\"emailNotify\">Email Notifications</label>\n                    </div>\n                    <div class=\"form-check\">\n                        <input class=\"form-check-input\" type=\"checkbox\" id=\"smsNotify\" name=\"smsNotify\" <?= $settings['sms_notify'] ? 'checked' : '' ?> />\n                        <label class=\"form-check-label\" for=\"smsNotify\">SMS Notifications</label>\n                    </div>\n                </section>\n\n                <section class=\"mb-4\">\n                    <h5><i class=\"bi bi-gear-fill me-2\"></i>System Settings</h5>\n                    <div class=\"form-check form-switch\">\n                        <input class=\"form-check-input\" type=\"checkbox\" id=\"maintenanceMode\" name=\"maintenanceMode\" <?= $settings['maintenance_mode'] ? 'checked' : '' ?> />\n                        <label class=\"form-check-label\" for=\"maintenanceMode\">Maintenance Mode</label>\n                    </div>\n                    <div class=\"form-check form-switch\">\n                        <input class=\"form-check-input\" type=\"checkbox\" id=\"autoBackup\" name=\"autoBackup\" <?= $settings['auto_backup'] ? 'checked' : '' ?> />\n                        <label class=\"form-check-label\" for=\"autoBackup\">Automatic Backups</label>\n                    </div>\n                </section>\n\n                <div class=\"text-end\">\n                    <button type=\"submit\" class=\"btn btn-primary px-4\">\n                        <i class=\"bi bi-save me-2\"></i>Save Changes\n                    </button>\n                </div>\n            </form>\n        </div>\n    </main>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n</body>\n</html>\n"
        }
    ]
}